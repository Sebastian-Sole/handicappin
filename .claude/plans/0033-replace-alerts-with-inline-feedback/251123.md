# Replace Browser Alerts with Inline Contextual Feedback - Implementation Plan

## Overview

Replace browser `alert()` calls in the PlanSelector component with inline Alert components that appear contextually where the user is interacting, providing better UX through immediate visual feedback without blocking interactions.

## Current State Analysis

**Alert Usage in `components/billing/plan-selector.tsx`:**
- Line 68: Success after downgrade to free plan
- Line 80: Error when free plan selection fails
- Line 98-100: Rate limit error for paid plan changes
- Line 115: Success after paid plan update (upgrade/downgrade)
- Line 128-130: Rate limit error for checkout creation
- Line 142: Error when plan change fails

**Problems with Current Implementation:**
- Browser alerts are blocking and jarring
- Stop all user interaction until dismissed
- Cannot be styled to match app design
- Poor accessibility
- No visual hierarchy for success vs error
- Messages disappear when dismissed (user can't re-read)

**Existing Components We Can Use:**
- ✅ `components/ui/alert.tsx` - shadcn Alert component with variants
- ✅ `lucide-react` icons already installed
- ✅ Similar pattern exists in `usage-limit-alert.tsx` as reference

## Desired End State

Users see inline feedback messages that:
1. Appear **above the plan cards** where they're looking
2. Use **color and icons** to indicate success (green) or error (red)
3. **Auto-dismiss success messages** after 5 seconds
4. **Keep error messages visible** until user takes action
5. Include **clear, actionable messaging** about what happened and next steps
6. Use **smooth animations** for appearing/disappearing
7. Are **accessible** with proper ARIA roles

### Success Verification

**Automated:**
- [x] Type checking passes: `pnpm build`
- [x] No TypeScript errors in plan-selector.tsx
- [x] Component renders without console errors

**Manual:**
- [ ] Success message appears inline when plan is updated
- [ ] Error message appears inline when plan change fails
- [ ] Rate limit message appears inline with countdown
- [ ] Messages are visible and readable on mobile
- [ ] Success messages auto-dismiss after 5 seconds
- [ ] Error messages stay visible until dismissed
- [ ] Animations are smooth and not jarring
- [ ] Screen reader announces alerts properly
- [ ] No browser alerts remain in component

## What We're NOT Doing

- ❌ Using Toast notifications (appear in corner, not contextual)
- ❌ Using Dialog modals (blocking, too heavy for notifications)
- ❌ Creating new reusable notification component (use existing Alert)
- ❌ Adding confirmation dialogs before actions (separate concern)
- ❌ Changing the plan change logic itself
- ❌ Updating other components that use alerts (separate tickets)
- ❌ Adding undo functionality

## Implementation Approach

Use the existing shadcn Alert component with inline placement directly above the plan grid. Add state management for feedback messages and auto-dismiss logic for success states.

---

## Phase 1: Add Inline Feedback State

### Overview
Add state to track feedback messages and create the inline Alert component rendering logic.

### Changes Required

#### 1. Update PlanSelector Component State

**File**: `components/billing/plan-selector.tsx`
**Changes**: Add state for inline feedback at line 49 (after existing useState)

```typescript
const [feedbackMessage, setFeedbackMessage] = useState<{
  type: "success" | "error";
  title: string;
  message: string;
} | null>(null);
```

**Explanation**: This state will hold the current feedback message to display. `null` means no message is showing.

#### 2. Add Auto-Dismiss Effect

**File**: `components/billing/plan-selector.tsx`
**Changes**: Add useEffect after state declarations (around line 55)

```typescript
// Auto-dismiss success messages after 5 seconds
useEffect(() => {
  if (feedbackMessage?.type === "success") {
    const timer = setTimeout(() => {
      setFeedbackMessage(null);
    }, 5000);

    return () => clearTimeout(timer);
  }
}, [feedbackMessage]);
```

**Explanation**: Success messages auto-dismiss to avoid cluttering the UI. Error messages stay until user action.

#### 3. Add Required Imports

**File**: `components/billing/plan-selector.tsx`
**Changes**: Add imports at top of file (around line 3)

```typescript
import { useEffect } from "react";
import { Alert, AlertDescription, AlertTitle } from "@/components/ui/alert";
import { CheckCircle2, XCircle, Clock } from "lucide-react";
```

**Explanation**: Import Alert components and icons for success/error/rate-limit states.

### Success Criteria

#### Automated Verification:
- [x] TypeScript compilation passes: `pnpm build`
- [x] No unused variable warnings
- [x] Imports resolve correctly

#### Manual Verification:
- [ ] Component renders without errors
- [ ] No console warnings about missing dependencies
- [ ] State is properly typed

---

## Phase 2: Replace Alert Calls with State Updates

### Overview
Replace all 6 `alert()` calls with `setFeedbackMessage()` calls that update our inline feedback state.

### Changes Required

#### 1. Replace Success Alert for Free Plan Downgrade

**File**: `components/billing/plan-selector.tsx`
**Changes**: Replace line 68

```typescript
// OLD:
alert(result.data.message);

// NEW:
setFeedbackMessage({
  type: "success",
  title: "Plan Updated",
  message: result.data.message,
});
```

**Location**: Inside `handleFreePlan` function, after successful subscription update

#### 2. Replace Error Alert for Free Plan Failure

**File**: `components/billing/plan-selector.tsx`
**Changes**: Replace line 80

```typescript
// OLD:
alert("Failed to select free plan. Please try again.");

// NEW:
setFeedbackMessage({
  type: "error",
  title: "Failed to Update Plan",
  message: "We couldn't switch you to the free plan. Please try again or contact support if the issue persists.",
});
```

**Location**: Inside `handleFreePlan` catch block

#### 3. Replace Rate Limit Alert for Paid Plan Updates

**File**: `components/billing/plan-selector.tsx`
**Changes**: Replace lines 98-100

```typescript
// OLD:
alert(
  `Too many requests. Please wait ${result.error.retryAfter} seconds and try again.`
);

// NEW:
setFeedbackMessage({
  type: "error",
  title: "Too Many Requests",
  message: `Please wait ${result.error.retryAfter} seconds before trying again to avoid rate limiting.`,
});
```

**Location**: Inside `handlePaidPlan` when upgrade mode rate limit is hit

#### 4. Replace Success Alert for Paid Plan Update

**File**: `components/billing/plan-selector.tsx`
**Changes**: Replace line 115

```typescript
// OLD:
alert(result.data.message);

// NEW:
setFeedbackMessage({
  type: "success",
  title: "Plan Updated",
  message: result.data.message,
});
```

**Location**: Inside `handlePaidPlan` after successful subscription update

#### 5. Replace Rate Limit Alert for Checkout Creation

**File**: `components/billing/plan-selector.tsx`
**Changes**: Replace lines 128-130

```typescript
// OLD:
alert(
  `Too many requests. Please wait ${result.error.retryAfter} seconds and try again.`
);

// NEW:
setFeedbackMessage({
  type: "error",
  title: "Too Many Requests",
  message: `Please wait ${result.error.retryAfter} seconds before trying again to avoid rate limiting.`,
});
```

**Location**: Inside `handlePaidPlan` when checkout creation rate limit is hit

#### 6. Replace Error Alert for Plan Change Failure

**File**: `components/billing/plan-selector.tsx`
**Changes**: Replace line 142

```typescript
// OLD:
alert("Failed to process plan change. Please try again.");

// NEW:
setFeedbackMessage({
  type: "error",
  title: "Failed to Process Plan Change",
  message: "We couldn't complete your plan change. Please try again or contact support if the issue persists.",
});
```

**Location**: Inside `handlePaidPlan` catch block

### Success Criteria

#### Automated Verification:
- [x] No TypeScript errors: `pnpm build`
- [x] No unused variables
- [x] All alert() calls removed

#### Manual Verification:
- [ ] Grep search shows no remaining `alert(` calls in plan-selector.tsx
- [ ] State updates correctly when errors occur
- [ ] Success messages set properly

---

## Phase 3: Render Inline Alert Component

### Overview
Add the inline Alert component to the JSX to display feedback messages above the plan cards.

### Changes Required

#### 1. Add Inline Feedback Alert to JSX

**File**: `components/billing/plan-selector.tsx`
**Changes**: Add after the opening `<>` fragment (around line 149, before the upgrade mode messaging)

```typescript
return (
  <>
    {/* Inline Feedback Alert */}
    {feedbackMessage && (
      <div className="mb-6 animate-in fade-in-0 slide-in-from-top-2 duration-300">
        <Alert
          variant={feedbackMessage.type === "error" ? "destructive" : "default"}
          className={
            feedbackMessage.type === "success"
              ? "border-green-500/50 bg-green-50 dark:bg-green-950/20"
              : ""
          }
        >
          {feedbackMessage.type === "success" ? (
            <CheckCircle2 className="h-4 w-4 text-green-600 dark:text-green-500" />
          ) : feedbackMessage.title === "Too Many Requests" ? (
            <Clock className="h-4 w-4" />
          ) : (
            <XCircle className="h-4 w-4" />
          )}
          <AlertTitle>{feedbackMessage.title}</AlertTitle>
          <AlertDescription>{feedbackMessage.message}</AlertDescription>
        </Alert>
      </div>
    )}

    {/* Context-specific messaging for upgrade mode */}
    {mode === "upgrade" && currentPlan && (
      // ... existing code continues
```

**Explanation**:
- Conditionally renders Alert only when `feedbackMessage` is not null
- Uses Tailwind animation classes for smooth fade-in from top
- Success messages get green styling, errors use destructive variant
- Icon changes based on message type (checkmark, clock, or X)
- Placed above plan cards so it appears where user is looking

#### 2. Add Manual Dismiss for Error Messages (Optional Enhancement)

**File**: `components/billing/plan-selector.tsx`
**Changes**: Modify the Alert to add close button for errors

```typescript
<Alert
  variant={feedbackMessage.type === "error" ? "destructive" : "default"}
  className={
    feedbackMessage.type === "success"
      ? "border-green-500/50 bg-green-50 dark:bg-green-950/20"
      : "relative pr-12" // Make room for close button
  }
>
  {feedbackMessage.type === "success" ? (
    <CheckCircle2 className="h-4 w-4 text-green-600 dark:text-green-500" />
  ) : feedbackMessage.title === "Too Many Requests" ? (
    <Clock className="h-4 w-4" />
  ) : (
    <XCircle className="h-4 w-4" />
  )}
  <AlertTitle>{feedbackMessage.title}</AlertTitle>
  <AlertDescription>{feedbackMessage.message}</AlertDescription>

  {/* Close button for error messages */}
  {feedbackMessage.type === "error" && (
    <button
      onClick={() => setFeedbackMessage(null)}
      className="absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2"
      aria-label="Dismiss error message"
    >
      <X className="h-4 w-4" />
    </button>
  )}
</Alert>
```

**Note**: This requires importing `X` from lucide-react. Add it to the imports from Phase 1.

### Success Criteria

#### Automated Verification:
- [x] TypeScript build passes: `pnpm build`
- [x] No React warnings in console
- [x] Proper ARIA roles present in DOM

#### Manual Verification:
- [ ] Alert appears above plan cards when message is set
- [ ] Success alert shows green with checkmark icon
- [ ] Error alert shows red with X icon
- [ ] Rate limit alert shows clock icon
- [ ] Alert animates smoothly into view
- [ ] Success alert auto-dismisses after 5 seconds
- [ ] Error alert stays visible
- [ ] Alert is readable on mobile and desktop
- [ ] Screen reader announces alert content
- [ ] Close button works for error messages (if implemented)

---

## Phase 4: Clear Feedback on New Actions

### Overview
Ensure feedback messages clear when user starts a new action, preventing stale messages from confusing users.

### Changes Required

#### 1. Clear Feedback at Start of handleFreePlan

**File**: `components/billing/plan-selector.tsx`
**Changes**: Add at start of `handleFreePlan` function (around line 55)

```typescript
const handleFreePlan = async () => {
  try {
    setLoading("free");
    setFeedbackMessage(null); // Clear any previous feedback

    // ... rest of function
```

**Explanation**: When user clicks a plan button, clear any old success/error messages.

#### 2. Clear Feedback at Start of handlePaidPlan

**File**: `components/billing/plan-selector.tsx`
**Changes**: Add at start of `handlePaidPlan` function (around line 87)

```typescript
const handlePaidPlan = async (plan: "premium" | "unlimited" | "lifetime") => {
  try {
    setLoading(plan);
    setFeedbackMessage(null); // Clear any previous feedback

    // ... rest of function
```

**Explanation**: Ensures no stale messages remain when starting a new plan change.

### Success Criteria

#### Automated Verification:
- [x] TypeScript passes: `pnpm build`
- [x] No linting errors

#### Manual Verification:
- [ ] Old success message clears when clicking new plan
- [ ] Old error message clears when retrying
- [ ] Only current action's feedback shows
- [ ] No message duplication or overlap

---

## Phase 5: Handle Navigation Timing for Success Messages

### Overview
Adjust navigation timing after successful plan changes to ensure user sees the success message before being redirected.

### Changes Required

#### 1. Delay Navigation After Free Plan Success

**File**: `components/billing/plan-selector.tsx`
**Changes**: Modify navigation after free plan downgrade success (around line 68-70)

```typescript
// Show success message
setFeedbackMessage({
  type: "success",
  title: "Plan Updated",
  message: result.data.message,
});

// Delay navigation to allow user to see success message
setTimeout(() => {
  router.push("/billing");
  router.refresh();
}, 2000); // 2 second delay (message stays for 5 total)

return; // Don't continue to immediate navigation
```

**Important**: Remove or comment out the immediate navigation that was after the alert():
```typescript
// OLD immediate navigation - REMOVE:
// router.push("/billing");
// router.refresh();
```

#### 2. Delay Navigation After Paid Plan Success

**File**: `components/billing/plan-selector.tsx`
**Changes**: Modify navigation after paid plan update success (around line 115-117)

```typescript
// Show success message
setFeedbackMessage({
  type: "success",
  title: "Plan Updated",
  message: result.data.message,
});

// Delay navigation to allow user to see success message
setTimeout(() => {
  router.push("/billing");
  router.refresh();
}, 2000);

return; // Don't continue to immediate navigation
```

**Important**: Remove or comment out the immediate navigation that was after the alert():
```typescript
// OLD immediate navigation - REMOVE:
// router.push("/billing");
// router.refresh();
```

### Success Criteria

#### Automated Verification:
- [x] TypeScript passes: `pnpm build`
- [x] No async/await issues

#### Manual Verification:
- [ ] Success message appears for 2 seconds before navigation
- [ ] User has time to read success message
- [ ] Navigation happens smoothly after delay
- [ ] Message doesn't feel too slow or too fast
- [ ] Page doesn't feel "stuck" after success

---

## Testing Strategy

### Unit Tests (Future - Out of Scope for This Plan)
- Test feedbackMessage state updates correctly
- Test auto-dismiss timer clears properly
- Test error messages don't auto-dismiss

### Manual Testing Checklist

#### Success Flow - Downgrade to Free
1. Navigate to `/upgrade` as a Premium user
2. Click "Start Free" button
3. **Verify**: Green success alert appears above plan cards
4. **Verify**: Alert shows checkmark icon and success message
5. **Verify**: Alert is visible for ~2 seconds
6. **Verify**: User is redirected to `/billing`
7. **Verify**: Alert auto-dismisses (if still on page)

#### Success Flow - Upgrade Plan
1. Navigate to `/upgrade` as a Premium user
2. Click "Subscribe" on Unlimited plan
3. **Verify**: Green success alert appears
4. **Verify**: Message explains upgrade is immediate
5. **Verify**: Navigation happens after 2 seconds
6. **Verify**: Screen reader announces success

#### Error Flow - API Failure
1. Navigate to `/upgrade`
2. Disconnect internet or use network throttling
3. Try to change plans
4. **Verify**: Red error alert appears inline
5. **Verify**: Alert shows X icon and error message
6. **Verify**: Alert does NOT auto-dismiss
7. **Verify**: Message provides helpful guidance
8. **Verify**: Close button works (if implemented)
9. Reconnect internet and retry
10. **Verify**: Old error clears when new action starts

#### Rate Limit Flow
1. Navigate to `/upgrade`
2. Rapidly click different plans to trigger rate limit
3. **Verify**: Red error alert appears with clock icon
4. **Verify**: Message shows retry time in seconds
5. **Verify**: Alert stays visible
6. Wait for retry period
7. **Verify**: Can successfully change plan after waiting

#### Accessibility Testing
1. **Keyboard Navigation**:
   - Tab through page with alert visible
   - Verify close button is keyboard accessible
   - Press Escape to dismiss (if implemented)

2. **Screen Reader**:
   - Use VoiceOver (Mac) or NVDA (Windows)
   - Verify alert is announced when it appears
   - Verify alert type (success/error) is conveyed
   - Verify message content is readable

3. **Visual**:
   - Test in light and dark mode
   - Verify color contrast meets WCAG AA
   - Test at 200% zoom
   - Verify readable on mobile (320px width)

#### Responsive Design Testing
1. **Mobile (320px - 768px)**:
   - Alert is full width
   - Text wraps appropriately
   - Icon and text are aligned
   - Close button is tappable (44px min)

2. **Tablet (768px - 1024px)**:
   - Alert width is appropriate
   - Doesn't look stretched
   - Plan cards below are visible

3. **Desktop (1024px+)**:
   - Alert max width constrains properly
   - Centers or aligns with plan cards
   - Plenty of breathing room

## Performance Considerations

- **Animation Performance**: Use CSS transforms for animations (GPU accelerated)
- **Memory Leaks**: Auto-dismiss timer is properly cleaned up in useEffect
- **Re-renders**: FeedbackMessage state only causes re-render when changed
- **Bundle Size**: No new dependencies added (using existing components)

## Accessibility Notes

- Alert component uses `role="alert"` for screen reader announcements
- Color is not the only indicator (icons + text provide context)
- Success/error states are clearly labeled with text
- Auto-dismiss timing (5s) follows WCAG 2.2 guidelines for non-critical messages
- Error messages don't auto-dismiss, giving users time to read
- Focus management: Alert doesn't trap focus (non-modal)

## Migration Notes

No data migration needed. This is a pure UI enhancement with no API or database changes.

## Edge Cases to Consider

1. **Multiple rapid clicks**: Feedback clears on new action start
2. **Slow network**: Loading state shows until success/error
3. **Component unmount during timer**: useEffect cleanup handles this
4. **Success then immediate error**: New message replaces old one
5. **Very long error messages**: AlertDescription handles text wrapping
6. **Redirect during auto-dismiss**: Timer is cleaned up properly

## References

- Original ticket: `.claude/tickets/0033-replace-alerts-with-shadcn-dialog.md`
- Related ticket: `.claude/tickets/0009-enhance-billing-ui-feedback.md`
- Alert component: `components/ui/alert.tsx`
- Similar pattern: `components/scorecard/usage-limit-alert.tsx`
- Current implementation: `components/billing/plan-selector.tsx:68,80,98,115,128,142`
