# Fix Paid-to-Free Downgrade Flow Implementation Plan

## Overview

Fix a critical billing bug where paid users downgrading to the free plan bypass Stripe cancellation logic, causing immediate database updates without canceling the active subscription. This creates data inconsistency and continued billing.

**Root Cause:** The `handleFreePlan()` function in `PlanSelector` doesn't distinguish between onboarding (new users) and upgrade mode (paid users downgrading). It always calls `createFreeTierSubscription()` which directly updates the database, bypassing Stripe.

**Solution:** Add conditional logic to `handleFreePlan()` to detect upgrade mode with paid plan, then call the existing subscription update API instead of directly updating the database.

## Current State Analysis

### What Works (No Changes Needed) ✅

1. **Subscription Update API** - `app/api/stripe/subscription/route.ts:80-144`
   - PUT endpoint correctly handles downgrade to free
   - Calls `updateSubscription()` in `lib/stripe.ts:179-185`
   - Sets `cancel_at_period_end: true` via Stripe API
   - Returns user-friendly message

2. **Webhook Handlers** - `app/api/stripe/webhook/route.ts`
   - `customer.subscription.updated` (lines 83-85) → updates `cancel_at_period_end` flag
   - `customer.subscription.deleted` (lines 87-89) → reverts to free plan
   - Both handlers increment `billing_version` for JWT cache invalidation

3. **Billing Page UI** - `app/billing/page.tsx:33-39`
   - Already shows "Cancels on [date]" when `cancelAtPeriodEnd = true`
   - Shows "Renews on [date]" for active subscriptions

4. **Access Control** - `utils/billing/access-control.ts`
   - `getComprehensiveUserAccess()` reads from database `plan_selected`
   - Since database doesn't change until period end, user retains access ✅

### What's Broken ❌

**File:** `components/billing/plan-selector.tsx`
**Function:** `handleFreePlan()` (lines 52-64)

```typescript
const handleFreePlan = async () => {
  try {
    setLoading("free");
    await createFreeTierSubscription(userId); // ❌ ALWAYS updates DB directly
    router.push("/");
    router.refresh();
  } catch (error) {
    console.error("Error selecting free plan:", error);
    alert("Failed to select free plan. Please try again.");
  } finally {
    setLoading(null);
  }
};
```

**Problem:** No check for `mode === "upgrade"` with `currentPlan !== "free"`. A paid user clicking "Free" immediately updates the database without canceling the Stripe subscription.

## Desired End State

### Success Criteria

#### Automated Verification:
- [ ] Type checking passes: `pnpm build`
- [ ] No linting errors: `pnpm lint`

#### Manual Verification:
- [ ] **Premium → Free:** User clicks "Free" on `/upgrade` page
  - Alert shows: "Subscription will cancel at the end of your billing period"
  - Redirects to `/billing` (NOT home page)
  - Database still shows `plan_selected = 'premium'`
  - Stripe dashboard shows `cancel_at_period_end: true`
  - Billing page shows "Cancels on [date]"
  - User can still access premium features

- [ ] **Unlimited → Free:** Same behavior as Premium → Free

- [ ] **New User → Free (Onboarding):** User clicks "Free" on `/onboarding` page
  - Database immediately updates to `plan_selected = 'free'`
  - Redirects to home page
  - No Stripe interaction

- [ ] **Free → Free (Upgrade page):** User already on free plan
  - Button disabled
  - Shows "Current Plan"

## What We're NOT Doing

- Implementing immediate cancellation (user pays for full billing cycle)
- Adding refund logic
- Implementing reactivation flow (separate ticket)
- Email notifications about cancellation
- Confirmation modals or dialogs (keep it simple for now)

## Implementation Approach

**Single-Function Fix:** Modify `handleFreePlan()` to detect upgrade mode with paid plan and route to the subscription update API instead of direct database update.

**Key Design Decision:** Use existing API infrastructure rather than creating new logic. All supporting systems (webhooks, UI, access control) already work correctly.

---

## Phase 1: Update PlanSelector Logic

### Overview
Modify the `handleFreePlan()` function to route paid users through the subscription cancellation flow.

### Changes Required

#### 1. Update `handleFreePlan()` Function

**File:** `components/billing/plan-selector.tsx`
**Lines:** 52-64
**Changes:** Add conditional logic to detect upgrade mode with paid plan

```typescript
const handleFreePlan = async () => {
  try {
    setLoading("free");

    // If in upgrade mode and user has a paid plan, use subscription update API
    if (mode === "upgrade" && currentPlan && currentPlan !== "free") {
      const response = await fetch("/api/stripe/subscription", {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ newPlan: "free" }),
      });

      const result = await response.json();

      if (!response.ok) {
        throw new Error(result.error || "Failed to update subscription");
      }

      // Show success message
      alert(result.message); // "Subscription will cancel at the end of your billing period"
      router.push("/billing");
      router.refresh();
      return;
    }

    // Otherwise, for onboarding or already-free users, use direct action
    await createFreeTierSubscription(userId);
    router.push("/");
    router.refresh();
  } catch (error) {
    console.error("Error selecting free plan:", error);
    alert("Failed to select free plan. Please try again.");
  } finally {
    setLoading(null);
  }
};
```

**Why This Works:**
1. **Upgrade mode check:** `mode === "upgrade"` ensures we're on `/upgrade` page (not `/onboarding`)
2. **Paid plan check:** `currentPlan && currentPlan !== "free"` ensures user has active paid subscription
3. **API call:** Routes to existing PUT endpoint which calls `updateSubscription()`
4. **Stripe interaction:** API sets `cancel_at_period_end: true` via Stripe SDK
5. **Database update:** Webhook handler updates database when Stripe fires `customer.subscription.updated`
6. **User feedback:** Alert shows cancellation message, redirects to `/billing` to see status
7. **Fallback:** Onboarding users and free users still use direct `createFreeTierSubscription()`

### Success Criteria

#### Automated Verification:
- [x] No TypeScript errors: `pnpm build` ✅
- [x] No linting errors: `pnpm lint` ✅
- [ ] No runtime errors when component loads (requires manual testing)

#### Manual Verification:
- [ ] Premium user clicks "Free" on `/upgrade` → sees alert → redirects to `/billing`
- [ ] Stripe dashboard shows `cancel_at_period_end: true` for subscription
- [ ] Database still shows `plan_selected = 'premium'` (doesn't change immediately)
- [ ] Billing page displays "Cancels on [date]" with correct period end date
- [ ] User can still access dashboard/premium features
- [ ] New user clicks "Free" on `/onboarding` → database updates immediately → redirects to home
- [ ] Free user on `/upgrade` page → "Free" button is disabled

---

## Phase 2: Verification Testing

### Overview
Test the complete flow end-to-end to ensure Stripe webhooks fire correctly and database updates at period end.

### Testing Steps

#### Test 1: Premium → Free Downgrade
1. Create test Premium subscription in Stripe (use test mode)
2. Navigate to `/upgrade` page
3. Click "Free" plan button
4. Verify alert message appears
5. Verify redirect to `/billing` page
6. **Check Stripe Dashboard:**
   - Open subscription in Stripe dashboard
   - Verify `cancel_at_period_end: true`
   - Note the `current_period_end` date
7. **Check Database:**
   - Query profile table for user
   - Verify `plan_selected = 'premium'` (NOT 'free')
   - Verify `cancel_at_period_end = true`
8. **Check Billing Page:**
   - Should show "Cancels on [date]"
   - Date should match `current_period_end`
9. **Test Access Control:**
   - Navigate to `/dashboard`
   - Verify user can still access premium features
   - Try adding a round (should work)
10. **Advance to Period End (Stripe Test Clock):**
    - Use Stripe test clock to advance time to `current_period_end + 1 day`
    - Verify webhook fires: `customer.subscription.deleted`
    - Check database: `plan_selected = 'free'`
    - Check billing page: Should now show "Free Plan"
    - Test access control: User should lose premium features

#### Test 2: Unlimited → Free Downgrade
Same steps as Test 1, but start with Unlimited plan.

#### Test 3: New User → Free (Onboarding Flow)
1. Create new test user (no plan selected)
2. Navigate to `/onboarding` page
3. Click "Free" plan button
4. **Verify:**
   - No API call to Stripe
   - Immediate database update: `plan_selected = 'free'`
   - Redirect to home page (NOT `/billing`)
   - No alert message

#### Test 4: Free → Free (Idempotent)
1. User already on free plan
2. Navigate to `/upgrade` page
3. **Verify:**
   - "Free" button shows "Current Plan"
   - Button is disabled (`disabled={loading !== null || currentPlan === "free"}`)

### Success Criteria

#### Automated Verification:
- [ ] All tests run without errors
- [ ] Webhook events recorded in `webhook_events` table

#### Manual Verification:
- [ ] Premium → Free downgrade schedules cancellation (doesn't cancel immediately)
- [ ] Database remains on paid plan until period end
- [ ] Billing page shows "Cancels on [date]"
- [ ] User retains access until period end
- [ ] Webhook fires at period end and reverts plan to free
- [ ] Onboarding flow unchanged (immediate database update)
- [ ] Free → Free is a no-op (button disabled)

---

## Testing Strategy

### Unit Tests (Optional - Not Required for DoD)
Could add tests for:
- `handleFreePlan()` with `mode="onboarding"` → calls `createFreeTierSubscription()`
- `handleFreePlan()` with `mode="upgrade"` + `currentPlan="premium"` → calls API
- `handleFreePlan()` with `mode="upgrade"` + `currentPlan="free"` → no-op

### Integration Tests
Manual testing with Stripe test mode is sufficient:
1. Use Stripe test cards (e.g., `4242 4242 4242 4242`)
2. Create test subscriptions via checkout
3. Test downgrade flow
4. Use Stripe test clock to simulate period end
5. Verify webhook delivery and database updates

### Manual Testing Checklist
- [ ] Test with Stripe test mode enabled
- [ ] Test all plan combinations: Premium → Free, Unlimited → Free
- [ ] Test onboarding flow (new user → Free)
- [ ] Test button states (disabled for current plan)
- [ ] Verify webhook events in Stripe dashboard
- [ ] Verify database consistency throughout flow
- [ ] Test access control before and after period end

---

## Edge Cases & Considerations

### Handled by Existing Code ✅

1. **User clicks "Free" multiple times:**
   - API is idempotent - `cancel_at_period_end` already true
   - Stripe handles gracefully
   - Button shows loading state during first click

2. **Webhook arrives before API response:**
   - `billing_version` increment ensures JWT cache invalidation
   - Database update is atomic via webhook
   - No race condition issues

3. **User upgrades after scheduling cancellation:**
   - `handlePaidPlan()` (lines 66-118) already handles upgrade mode
   - API call clears `cancel_at_period_end` when updating subscription
   - Stripe automatically handles plan change

4. **Subscription already past_due:**
   - Stripe API will return error if subscription inactive
   - Error handling catches and shows user-friendly message
   - Webhook `subscription.deleted` will have already reverted to free

### Not Handled (Out of Scope)

1. **Lifetime plan downgrade to free:**
   - Lifetime is NOT a subscription (one-time payment)
   - No subscription ID to cancel
   - `getAvailablePlans()` (line 30) shows "Free" as option for lifetime users
   - **QUESTION:** Should lifetime users be able to downgrade? If so, how?

2. **Cancellation confirmation modal:**
   - Currently uses `alert()` for simplicity
   - Could enhance with shadcn dialog (separate ticket #0033)

3. **Email notifications:**
   - No email sent when user schedules cancellation
   - Could add via separate ticket

---

## Performance Considerations

**No performance impact.** The change adds a conditional check and API call only when:
1. User is on `/upgrade` page (not frequently visited)
2. User has paid plan (small subset of users)
3. User clicks "Free" button (rare action)

The API call is fast (Stripe API typically responds in <200ms).

---

## Migration Notes

**No migration needed.** This is a bug fix that doesn't affect existing data or database schema.

**Backward Compatibility:**
- Onboarding flow unchanged
- Existing free users unaffected
- Paid users who already scheduled cancellation via Stripe portal continue to work

---

## References

- **Ticket:** `.claude/tickets/0032-fix-paid-to-free-downgrade-flow.md`
- **Related Code:**
  - `components/billing/plan-selector.tsx` (main fix)
  - `app/api/stripe/subscription/route.ts` (PUT handler - already works)
  - `lib/stripe.ts:179-185` (updateSubscription - already works)
  - `app/api/stripe/webhook/route.ts:1036-1107` (webhooks - already work)
  - `app/billing/page.tsx:33-39` (UI - already works)
  - `utils/billing/access-control.ts` (access control - already works)

---

## Definition of Done

- [x] Research completed - root cause identified
- [x] Code changes implemented in `handleFreePlan()` and `getAvailablePlans()`
- [x] Type checking passes: `pnpm build`
- [x] Linting passes: `pnpm lint`
- [ ] Manual testing completed for all flows:
  - [ ] Premium → Free downgrade
  - [ ] Unlimited → Free downgrade
  - [ ] New user → Free (onboarding)
  - [ ] Free → Free (no-op)
  - [ ] Lifetime → (no options shown on upgrade page)
- [ ] Webhook delivery verified via Stripe dashboard
- [ ] Database consistency verified at each step
- [ ] Access control tested before and after period end
- [ ] Test clock used to simulate period end and verify final state

---

## Design Decisions

### Decision 1: Lifetime Plan Downgrade ✅
**Decision:** Remove "Free" from available plans for lifetime users.

**Rationale:** Lifetime is a one-time payment for permanent access. There's no subscription to cancel, and downgrading doesn't make sense conceptually. User paid once for lifetime access and should keep it unless they delete their account.

**Implementation:** `getAvailablePlans()` returns `[]` for lifetime users (line 34).

### Decision 2: User Feedback Mechanism ✅
**Decision:** Use simple `alert()` for cancellation confirmation.

**Rationale:** Keep implementation simple and fast. Proper confirmation modal with shadcn dialog is tracked in separate ticket #0033 for replacing all alerts with proper UI components.

**Implementation:** `alert(result.message)` shows Stripe API response message (line 71).

---

## Implementation Notes

### Why This Is a Single-Function Fix
All the infrastructure already exists:
1. ✅ API endpoint handles free plan downgrade
2. ✅ Stripe SDK call sets `cancel_at_period_end`
3. ✅ Webhooks update database at period end
4. ✅ Billing UI shows cancellation status
5. ✅ Access control respects period end date

The ONLY missing piece is routing paid users through the API instead of direct DB update.

### Why Redirect to `/billing` Instead of Home
Paid users downgrading need to see:
- Confirmation that cancellation was scheduled
- The exact date their subscription ends
- Current plan status

The `/billing` page already displays all this information correctly.

### Why Keep Onboarding Flow Separate
Onboarding users (no Stripe customer, no subscription) should NOT go through Stripe API:
- No subscription to cancel
- Direct database update is correct
- No webhook needed
- Faster user experience

The conditional `if (mode === "upgrade" && currentPlan && currentPlan !== "free")` ensures we only use the API for the specific case where it's needed.
