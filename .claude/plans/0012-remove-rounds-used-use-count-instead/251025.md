# Remove rounds_used Column - Use COUNT Instead

## Overview

Replace the denormalized `rounds_used` column in the profile table with on-demand COUNT queries from the round table. This establishes a single source of truth for round counting, eliminates synchronization issues, and simplifies the codebase while maintaining acceptable performance for free tier users.

## Current State Analysis

**Denormalized Approach:**
- Profile table contains `rounds_used` integer column (default 0)
- Manually incremented after each round submission (server/api/routers/round.ts:402-412)
- Read by access control functions to calculate remaining rounds (25 - rounds_used)
- Only used for free tier users; always 0 for paid users

**Problems Identified:**
1. Can get out of sync if rounds deleted manually or errors occur during increment
2. Adds unnecessary bloat to profile table
3. Requires maintenance in multiple places
4. Not the source of truth (round table is)
5. **Critical: NO INDEX on `round.userId`** - COUNT queries would be slow without index

**Current References:**
- `db/schema.ts:39` - Schema definition
- `utils/billing/access-control.ts:45, 61, 161, 172` - Read operations
- `server/api/routers/round.ts:402-412` - Write operation (increment)
- `utils/billing/access-helpers.ts:23` - Helper function parameter
- `app/profile/[id]/page.tsx:141` - UI display (debug only)
- `supabase/migrations/20251011130000_add_plan_tracking_to_profile.sql` - Original creation

## Desired End State

**Single Source of Truth Approach:**
- Remove `rounds_used` column from profile table entirely
- Add B-tree index on `round.userId` for fast COUNT queries
- Free tier: Execute `COUNT(*) FROM round WHERE userId = ?` on-demand
- Paid tier: No counting (always unlimited)
- Post-insert re-check to prevent race conditions

**Performance Characteristics:**
- COUNT query with index: ~5-20ms
- Only executed for free tier users
- Only executed during:
  1. Access checks before round submission
  2. UI display of "X rounds remaining"
- Paid users: Zero overhead
- Race condition protection: Extra ~10ms for free users only

**Verification:**
- Free user at limit (25 rounds) cannot submit more rounds
- Free user under limit can submit rounds normally
- Paid users unaffected (unlimited rounds)
- COUNT always matches actual round count
- No `rounds_used` column exists in database or schema
- Index on `round.userId` exists and is used by query planner

## What We're NOT Doing

- Adding Redis caching for COUNT results
- Changing the free tier limit (stays at 25)
- Modifying paid user round tracking
- Adding round analytics or reporting
- Implementing soft deletes for rounds
- Pre-validating COUNT matches rounds_used before migration (trust COUNT as source of truth)
- Creating rollback migration (manual rollback via `supabase db reset`)
- Adding pessimistic locking or complex transactions

---

## Phase 1: Update Schema & Generate Migration

### Overview

Update Drizzle schema to remove `rounds_used` column and add index on `round.userId`, then generate SQL migration using drizzle-kit.

### Changes Required

#### 1. Add Index Import

**File:** `db/schema.ts`
**Location:** Line 2 (add to existing imports)

```typescript
import {
  pgTable,
  uniqueIndex,
  foreignKey,
  pgPolicy,
  uuid,
  text,
  decimal,
  boolean,
  serial,
  integer,
  timestamp,
  pgSchema,
  index, // ADD THIS
} from "drizzle-orm/pg-core";
```

#### 2. Remove rounds_used Column

**File:** `db/schema.ts`
**Location:** Line 39
**Action:** DELETE this line entirely

```typescript
// DELETE THIS LINE:
roundsUsed: integer("rounds_used").default(0).notNull(),
```

**Result:** Profile table schema should go from lines 38-43:
```typescript
// Billing/plan tracking fields
planSelected: text("plan_selected").$type<
  "free" | "premium" | "unlimited" | "lifetime" | null
>(),
planSelectedAt: timestamp("plan_selected_at"),
```

#### 3. Add Index on round.userId

**File:** `db/schema.ts`
**Location:** Line 233 (in round table constraints array, before foreignKey definitions)

```typescript
export const round = pgTable(
  "round",
  {
    // ... fields ...
  },
  (table) => [
    // ADD THIS INDEX FIRST (before foreign keys):
    index("idx_round_userId").on(table.userId),

    foreignKey({
      columns: [table.courseId],
      foreignColumns: [course.id],
      name: "round_courseId_fkey",
    })
      .onUpdate("cascade")
      .onDelete("restrict"),
    // ... rest of constraints ...
  ]
);
```

**Why First?** Convention is to define indexes before foreign keys and policies.

#### 4. Generate Migration

**Command:**
```bash
npx drizzle-kit generate
```

**Expected Output:**
- New migration file in `supabase/migrations/` with timestamp
- SQL should include:
  - `CREATE INDEX idx_round_userId ON round ("userId");`
  - `ALTER TABLE profile DROP COLUMN rounds_used;`

**Verify Generated SQL:**
- Open the generated migration file
- Confirm DROP COLUMN statement is present
- Confirm CREATE INDEX statement is present
- Check index is created BEFORE column is dropped (for zero-downtime if needed)

#### 5. Apply Migration

**Command:**
```bash
supabase db reset
```

**What This Does:**
- Resets local Supabase database
- Applies all migrations in order
- Confirms schema matches db/schema.ts

**Verification:**
```bash
# Check index exists
supabase db query "SELECT indexname FROM pg_indexes WHERE tablename = 'round' AND indexname = 'idx_round_userId';"

# Check column doesn't exist
supabase db query "SELECT column_name FROM information_schema.columns WHERE table_name = 'profile' AND column_name = 'rounds_used';"
```

### Success Criteria

#### Automated Verification:
- [x] Schema compiles without errors: `npx tsc --noEmit`
- [x] Migration generates successfully: `npx drizzle-kit generate`
- [x] Database resets without errors: `supabase db reset`

#### Manual Verification:
- [x] New migration file exists in `supabase/migrations/`
- [x] Migration SQL includes CREATE INDEX statement
- [x] Migration SQL includes DROP COLUMN statement
- [x] Query confirms index exists on round.userId
- [x] Query confirms rounds_used column does not exist
- [x] EXPLAIN ANALYZE shows index is used: `EXPLAIN SELECT COUNT(*) FROM round WHERE "userId" = '<uuid>';`

---

## Phase 2: Update Access Control Functions

### Overview

Replace `rounds_used` reads with COUNT queries in access control functions. Only affects free tier users.

### Changes Required

#### 1. Update getBasicUserAccess()

**File:** `utils/billing/access-control.ts`
**Location:** Lines 43-62

**BEFORE:**
```typescript
// Get user profile
const { data: profile, error: profileError } = await supabase
  .from("profile")
  .select("plan_selected, rounds_used")
  .eq("id", userId)
  .single();

if (profileError) {
  console.error("Error fetching profile:", profileError);
  return createNoAccessResponse();
}

// No plan selected yet
if (!profile.plan_selected) {
  return createNoAccessResponse();
}

// Free plan
if (profile.plan_selected === "free") {
  return createFreeTierResponse(profile.rounds_used || 0);
}
```

**AFTER:**
```typescript
// Get user profile
const { data: profile, error: profileError } = await supabase
  .from("profile")
  .select("plan_selected") // REMOVED rounds_used
  .eq("id", userId)
  .single();

if (profileError) {
  console.error("Error fetching profile:", profileError);
  return createNoAccessResponse();
}

// No plan selected yet
if (!profile.plan_selected) {
  return createNoAccessResponse();
}

// Free plan - COUNT rounds from database
if (profile.plan_selected === "free") {
  const { count, error: countError } = await supabase
    .from("round")
    .select("*", { count: "exact", head: true })
    .eq("userId", userId);

  if (countError) {
    console.error("Error counting rounds:", countError);
    return createFreeTierResponse(0);
  }

  return createFreeTierResponse(count || 0);
}
```

**Key Changes:**
- Remove `rounds_used` from SELECT query
- Add COUNT query for free tier users
- Error handling for COUNT query (fallback to 0)
- Pass COUNT result to createFreeTierResponse

#### 2. Update getComprehensiveUserAccess()

**File:** `utils/billing/access-control.ts`
**Location:** Lines 159-173

**BEFORE:**
```typescript
// 1. Get user profile (exists for ALL users)
const { data: profile, error: profileError } = await supabase
  .from("profile")
  .select("plan_selected, rounds_used")
  .eq("id", userId)
  .single();

if (profileError) {
  console.error("Error fetching profile:", profileError);
  return createNoAccessResponse();
}

// 2. Check if user selected free plan
if (profile.plan_selected === "free") {
  return createFreeTierResponse(profile.rounds_used || 0);
}
```

**AFTER:**
```typescript
// 1. Get user profile (exists for ALL users)
const { data: profile, error: profileError } = await supabase
  .from("profile")
  .select("plan_selected") // REMOVED rounds_used
  .eq("id", userId)
  .single();

if (profileError) {
  console.error("Error fetching profile:", profileError);
  return createNoAccessResponse();
}

// 2. Check if user selected free plan - COUNT rounds from database
if (profile.plan_selected === "free") {
  const { count, error: countError } = await supabase
    .from("round")
    .select("*", { count: "exact", head: true })
    .eq("userId", userId);

  if (countError) {
    console.error("Error counting rounds:", countError);
    return createFreeTierResponse(0);
  }

  return createFreeTierResponse(count || 0);
}
```

**Key Changes:**
- Same pattern as getBasicUserAccess()
- Remove `rounds_used` from SELECT query
- Add COUNT query for free tier users

### Success Criteria

#### Automated Verification:
- [x] TypeScript compiles without errors: `npx tsc --noEmit`
- [x] Linting passes: `pnpm lint`
- [x] No ESLint warnings about unused variables

#### Manual Verification:
- [x] Free tier user access check returns correct count
- [x] Paid user access check still returns Infinity (unaffected)
- [x] Error handling works (test by temporarily breaking COUNT query)
- [x] Console logs show "Error counting rounds" on COUNT failure

---

## Phase 3: Update Round Submission Logic

### Overview

Remove the manual `rounds_used` increment and add post-insert COUNT re-check for race condition protection.

### Changes Required

#### 1. Remove rounds_used Increment

**File:** `server/api/routers/round.ts`
**Location:** Lines 402-412
**Action:** DELETE entire block

```typescript
// DELETE THIS ENTIRE BLOCK (lines 402-412):
// Increment rounds_used for free tier users
if (access.plan === "free") {
  await db
    .update(profile)
    .set({
      roundsUsed: sql`${profile.roundsUsed} + 1`,
    })
    .where(eq(profile.id, userId));

  console.log("✅ Incremented rounds_used for free tier user");
}
```

#### 2. Add Post-Insert Race Condition Check

**File:** `server/api/routers/round.ts`
**Location:** Immediately after line 400 (after score insertion), BEFORE return statement
**Action:** ADD this new block

```typescript
console.log("Scores inserted");

// Race condition protection: re-check count for free tier users
// This prevents parallel submissions from exceeding the limit
if (access.plan === "free") {
  const { count, error: countError } = await ctx.supabase
    .from("round")
    .select("*", { count: "exact", head: true })
    .eq("userId", userId);

  if (countError) {
    console.error("Error re-checking round count:", countError);
    // Allow the submission - count check already passed pre-flight
  } else if (count && count > 25) {
    // User exceeded limit via race condition - rollback
    console.warn(
      `⚠️ Race condition detected: User ${userId} has ${count} rounds (limit: 25). Rolling back round ${newRound.id}`
    );

    await db.delete(round).where(eq(round.id, newRound.id));

    throw new TRPCError({
      code: "FORBIDDEN",
      message:
        "Round limit exceeded due to concurrent submissions. Your submission was not saved. Please try again.",
    });
  }

  console.log(
    `✅ Post-insert check passed. User has ${count} rounds (limit: 25)`
  );
}

return newRound;
```

**Key Points:**
- Only runs for free tier users
- Counts AFTER round is inserted (catches race condition)
- If over limit: deletes the round and throws error
- If count check fails: allows submission (already passed pre-flight check)
- Logs for debugging

#### 3. Add Import for eq (if not present)

**File:** `server/api/routers/round.ts`
**Location:** Line 4

**Verify this import exists:**
```typescript
import { eq, and, sql } from "drizzle-orm";
```

If `eq` is not imported, add it to the import statement.

### Success Criteria

#### Automated Verification:
- [x] TypeScript compiles without errors: `npx tsc --noEmit`
- [x] Linting passes: `pnpm lint`
- [x] Build succeeds: `pnpm build`

#### Manual Verification:
- [x] Free user with 24 rounds can submit 25th round successfully
- [x] Free user with 25 rounds CANNOT submit 26th round (blocked with error)
- [x] Error message is clear: "You've reached your free tier limit of 25 rounds"
- [x] Post-insert check logs appear in console for free tier submissions
- [x] Paid users can submit unlimited rounds (unaffected)
- [x] Race condition test: Fire 2 parallel submissions when at 24 rounds → only 25 rounds total exist

---

## Phase 4: Update UI Components (Optional Cleanup)

### Overview

Remove the debug display of `rounds_used` from the profile page since the column no longer exists.

### Changes Required

#### 1. Remove rounds_used Display

**File:** `app/profile/[id]/page.tsx`
**Location:** Line 141 (in "Plan Debugging Information" section)
**Action:** DELETE this line

```typescript
// DELETE THIS LINE:
<strong>Rounds Used:</strong> {profile.rounds_used}
```

**Alternative:** If you want to keep debugging info, replace with COUNT:

```typescript
// OPTIONAL: Replace with dynamic count (requires fetching)
<strong>Rounds in Database:</strong> {/* Fetch count from round table */}
```

**Note:** Since this is in a server component, you can fetch the count directly:

```typescript
// Add this query before rendering
const { count: roundCount } = await supabase
  .from("round")
  .select("*", { count: "exact", head: true })
  .eq("userId", id);

// Then in JSX:
<strong>Rounds in Database:</strong> {roundCount || 0}
```

### Success Criteria

#### Automated Verification:
- [x] TypeScript compiles without errors: `npx tsc --noEmit`
- [x] Linting passes: `pnpm lint`
- [x] Build succeeds: `pnpm build`

#### Manual Verification:
- [x] Profile page loads without errors
- [x] No "rounds_used" reference appears in UI
- [x] (Optional) Dynamic round count displays correctly if implemented
- [x] Other profile information displays correctly

---

## Testing Strategy

### Unit Tests (If Applicable)

**Access Control Functions:**
- Test `getBasicUserAccess()` with free user (mock COUNT query)
- Test `getComprehensiveUserAccess()` with free user (mock COUNT query)
- Test COUNT error handling (fallback to 0)
- Test paid users still get Infinity (unaffected)

**Round Submission:**
- Test pre-flight check blocks submission at limit
- Test post-insert check catches race condition
- Test error message content
- Mock parallel submissions to verify race condition handling

### Integration Tests

**Database Queries:**
```sql
-- Verify index exists and is used
EXPLAIN ANALYZE
SELECT COUNT(*) FROM round WHERE "userId" = '<test-user-uuid>';

-- Should show "Index Scan using idx_round_userId"
```

**Performance Test:**
```sql
-- Insert test data (100 rounds for one user)
-- Then measure COUNT query time
EXPLAIN (ANALYZE, BUFFERS)
SELECT COUNT(*) FROM round WHERE "userId" = '<test-user-uuid>';

-- Expected: < 20ms with index
```

### Manual Testing Checklist

#### Free Tier User Flow:
1. [ ] Create new free tier account
2. [ ] Submit 20 rounds → All succeed
3. [ ] Check profile page → Shows "5 rounds remaining"
4. [ ] Submit 5 more rounds → All succeed
5. [ ] Check profile page → Shows "0 rounds remaining"
6. [ ] Try to submit 26th round → Blocked with clear error
7. [ ] Delete 1 round → Now shows "1 round remaining"
8. [ ] Submit 1 round → Succeeds (count updates automatically)

#### Paid Tier User Flow:
1. [ ] Create paid account (premium/unlimited/lifetime)
2. [ ] Submit 50 rounds → All succeed
3. [ ] Check profile page → No round limit shown
4. [ ] Access check returns `remainingRounds: Infinity`
5. [ ] Performance: Submit round takes same time as before

#### Race Condition Test:
1. [ ] Set user to 24 rounds
2. [ ] Fire 2 parallel requests to submit round (use Postman or curl)
3. [ ] Verify only 25 rounds exist in database (not 26)
4. [ ] Verify one request succeeds, one gets FORBIDDEN error
5. [ ] Check logs for "Race condition detected" warning

#### Edge Cases:
1. [ ] User with 0 rounds (new account) → Can submit 25 rounds
2. [ ] User with exactly 25 rounds → Cannot submit more
3. [ ] User who downgraded from paid to free with 30 rounds → Blocked from submitting more
4. [ ] COUNT query failure (test by breaking query) → Falls back to 0, logs error

### Performance Testing

**Baseline Measurement (Before Changes):**
- Measure round submission time for free user: `<time>`
- Measure round submission time for paid user: `<time>`
- Measure profile page load time: `<time>`

**Post-Implementation Measurement:**
- Round submission time for free user: `<expected: +10-20ms>`
- Round submission time for paid user: `<expected: no change>`
- Profile page load time: `<expected: no change or faster>`

**SQL Query Performance:**
```sql
-- Should complete in < 20ms with index
EXPLAIN (ANALYZE, BUFFERS, TIMING)
SELECT COUNT(*) FROM round WHERE "userId" = '<uuid>';
```

**Expected Output:**
```
Index Scan using idx_round_userId on round (cost=0.15..8.17 rows=1 width=8) (actual time=0.023..0.145 rows=25 loops=1)
Planning Time: 0.089 ms
Execution Time: 0.178 ms
```

---

## Performance Considerations

### COUNT Query Performance

**With Index (idx_round_userId):**
- Small dataset (<50 rounds): 1-5ms
- Medium dataset (50-100 rounds): 5-15ms
- Large dataset (100+ rounds): 10-20ms

**Without Index (if index creation fails):**
- Sequential scan on entire table: 100-500ms+ (UNACCEPTABLE)

**Mitigation:**
- Index is created in Phase 1 BEFORE code changes
- Verify index exists before deploying code changes
- Monitor query performance with EXPLAIN ANALYZE

### Impact on User Experience

**Free Tier Users:**
- Pre-flight check: +10ms (COUNT query)
- Post-insert check: +10ms (COUNT query)
- Total latency increase: ~20ms (negligible)

**Paid Tier Users:**
- No COUNT queries executed
- Zero performance impact
- Same latency as before

**UI Rendering:**
- Profile page: May need COUNT query to show remaining rounds
- Can cache in component state during session
- No impact on paid users (don't show count)

### Database Load

**Current (with rounds_used):**
- Write: 1 UPDATE per round submission (free tier only)
- Read: 1 SELECT from profile (all users)

**After (with COUNT):**
- Write: 0 (no increment needed)
- Read: 1 COUNT query (free tier only)

**Net Impact:**
- Fewer writes (better for database)
- Reads are indexed and fast
- Overall: Neutral or slight improvement

---

## Migration Notes

### Local Development

1. Update `db/schema.ts` (Phase 1)
2. Run `npx drizzle-kit generate`
3. Run `supabase db reset`
4. Verify changes with SQL queries
5. Update code (Phases 2-4)
6. Test thoroughly with manual checklist

### Production Deployment

**⚠️ IMPORTANT: Index MUST be created before deploying code changes**

**Deployment Order:**
1. Apply database migration (creates index + drops column)
2. Wait for migration to complete (verify index exists)
3. Deploy code changes (access control + round submission)
4. Monitor error logs for COUNT query errors
5. Monitor performance metrics (round submission latency)

**Rollback Plan:**
- Manual restoration via `supabase db reset` with previous migration
- Alternatively: Manually add column back and populate from COUNT:
  ```sql
  ALTER TABLE profile ADD COLUMN rounds_used INTEGER DEFAULT 0;
  UPDATE profile SET rounds_used = (
    SELECT COUNT(*) FROM round WHERE round."userId" = profile.id
  ) WHERE plan_selected = 'free';
  ```

### Zero-Downtime Considerations

**Option 1: Blue-Green Deployment**
- Create index first (non-blocking)
- Deploy new code to staging
- Test thoroughly
- Switch traffic to new deployment
- Drop column in cleanup migration

**Option 2: Backwards Compatible (Not Needed Here)**
- Not necessary since dropping column doesn't break old code
- Old code just won't see the column (will error, but that's expected)

---

## References

- Original ticket: `.claude/tickets/0012-remove-rounds-used-use-count-instead.md`
- Original migration: `supabase/migrations/20251011130000_add_plan_tracking_to_profile.sql`
- Access control: `utils/billing/access-control.ts`
- Round submission: `server/api/routers/round.ts`
- Schema: `db/schema.ts`
- Constants: `utils/billing/constants.ts` (FREE_TIER_ROUND_LIMIT = 25)
