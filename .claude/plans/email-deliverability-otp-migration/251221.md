# Email Deliverability & OTP Migration Implementation Plan

> **Updated**: 2025-12-21
>
> - Uses shadcn `input-otp` component for better UX
> - Local DB testing workflow: `db/schema.ts` → `npx drizzle-kit generate` → `supabase db reset`

## Overview

This plan addresses three critical email issues affecting user experience and security:

1. Emails landing in spam folders (affecting all providers)
2. Delayed email delivery to Zoho/Outlook (3-15 minute delays)
3. Outlook Safe Links prefetching verification URLs causing "invalid access" errors

We'll migrate all verification emails to OTP-based authentication and configure proper email authentication (DMARC) to improve deliverability.

## Current State Analysis

### Email Infrastructure

- **Service**: Resend API (via `sebastiansole@handicappin.com`)
- **Domain**: handicappin.com
- **Current Auth**: SPF and DKIM likely configured (via Resend domain verification)
- **Missing**: DMARC configuration
- **Issue**: Using root domain instead of subdomain for transactional emails

### Email Flows Using Token-Based URLs (Vulnerable to Prefetching)

1. **Signup Verification** (`supabase/functions/send-verification-email/`)

   - File: `email.tsx:51`
   - Uses: `token_hash` in direct URL
   - Vulnerable: Yes - direct link to verification endpoint

2. **Email Change Verification** (`supabase/functions/request-email-change/`, `verify-email-change/`)

   - Files: `request-email-change/index.ts:218`, `email-verification-change.tsx:72`
   - Uses: JWT tokens in URL
   - Vulnerable: Yes - direct link consumption

3. **Password Reset** (`supabase/functions/reset-password/`)
   - Files: `reset-password/index.ts:86`, `email.tsx:41`
   - Uses: JWT tokens in URL
   - Vulnerable: Yes - could be prefetched

### Key Discoveries

- **Greylisting Note**: Line 312 in `lib/email-service.ts` already mentions Resend greylisting (451 codes) as a known issue
- **Existing Infrastructure**: `pending_email_changes` table exists (`db/schema.ts:548-583`) for email change workflow
- **Profile Verified Field**: `profile.verified` field exists (`db/schema.ts:35`) but not fully utilized
- **No OTP System**: No existing OTP tables, functions, or verification flows

## Desired End State

### Email Authentication & Deliverability

- DMARC policy configured (starting at `p=none`, progressing to `p=quarantine`)
- Transactional emails sent from dedicated subdomain (e.g., `mail.handicappin.com`)
- Email content optimized to avoid spam triggers
- Spam rate below 0.08%, bounce rate below 4%

### OTP-Based Verification System

- All verification flows use 6-digit numeric OTP codes
- OTPs expire after 15 minutes
- Users enter OTP on verification pages (not clickable links)
- Safe Links cannot prefetch and consume verification tokens
- Rate limiting prevents brute force attacks (max 5 attempts)

### User Experience

- Verification emails arrive quickly (under 1 minute)
- Emails don't land in spam folders
- Outlook users can verify without "invalid access" errors
- Clear, user-friendly OTP entry interfaces

### Success Criteria

#### Automated Verification

- [x] Unit tests pass: `pnpm test`
- [x] Type checking passes: `pnpm build`
- [x] Linting passes: `pnpm lint`
- [x] Database migrations apply successfully
- [ ] All edge functions deploy without errors

#### Manual Verification

- [ ] Signup verification works via OTP on Gmail, Outlook, Zoho
- [ ] Email change verification works via OTP
- [ ] Password reset works via OTP
- [ ] Emails arrive within 1 minute on all providers
- [ ] Zero "invalid access" errors from Safe Links
- [ ] Emails land in inbox (not spam) on all providers tested
- [ ] OTP rate limiting prevents brute force attacks
- [ ] Expired OTPs handled gracefully with clear error messages

## What We're NOT Doing

- **SMS OTP**: Only email-based OTP (no phone verification)
- **Magic Links**: Not implementing passwordless magic link authentication
- **Email Templates Redesign**: Using existing email template structure, only modifying content
- **Custom Email Service**: Continuing with Resend (not migrating to SendGrid, etc.)
- **2FA/MFA**: This is not multi-factor authentication, just verification migration
- **Automated DMARC Monitoring**: No automated DMARC report parsing (manual monitoring initially)
- **Email Reputation Warm-up**: Assuming existing domain has some reputation (not starting fresh)
- **Unsubscribe Flow Updates**: Out of scope (separate from verification emails)

## Implementation Approach

We'll use a **phased rollout** approach:

1. **Phase 1**: Infrastructure - DNS/DMARC configuration and database schema
2. **Phase 2**: OTP System Core - Create reusable OTP generation, storage, and verification logic
3. **Phase 3**: Signup Verification Migration - Convert to OTP (highest impact)
4. **Phase 4**: Email Change Verification Migration - Convert to OTP
5. **Phase 5**: Password Reset Migration - Convert to OTP
6. **Phase 6**: Email Content Optimization - Improve templates for deliverability
7. **Phase 7**: Monitoring & Testing - Production validation and metrics

This approach allows incremental testing and rollback capability at each phase.

### Local Database Testing Workflow

**All testing should be done on local Supabase database:**

1. Edit `db/schema.ts` with schema changes
2. Generate migration: `npx drizzle-kit generate`
3. Apply to local DB: `supabase db reset`
4. Test locally before deploying to production

This ensures safe iteration without affecting production data.

---

## Phase 1: DNS & Infrastructure Setup

### Overview

Configure email authentication (DMARC) and set up subdomain for transactional emails to improve deliverability.

### Changes Required

#### 1. DNS Records (Manual Configuration via DNS Provider)

**Action**: Add the following DNS records to `handicappin.com`:

**DMARC Record** (Start with monitoring policy):

```
Type: TXT
Name: _dmarc.handicappin.com
Value: v=DMARC1; p=none; rua=mailto:dmarc-reports@handicappin.com; ruf=mailto:dmarc-forensics@handicappin.com; fo=1;
TTL: 3600
```

**Explanation**:

- `p=none`: Monitor only (don't reject/quarantine yet)
- `rua`: Aggregate reports destination
- `ruf`: Forensic reports destination
- `fo=1`: Generate report if either SPF or DKIM fails

**After 2-4 weeks of monitoring**, upgrade to:

```
v=DMARC1; p=quarantine; rua=mailto:dmarc-reports@handicappin.com; ruf=mailto:dmarc-forensics@handicappin.com; pct=100; fo=1;
```

#### 2. Resend Domain Configuration

**Action**: Verify domain setup in Resend Dashboard

1. Log into Resend dashboard: https://resend.com/domains
2. Verify that `handicappin.com` shows:
   - ✅ SPF: Passing
   - ✅ DKIM: Passing
3. **Optional but Recommended**: Add subdomain `mail.handicappin.com` as separate domain in Resend
   - Benefit: Isolates transactional email reputation
   - Follow Resend's domain verification flow

#### 3. Environment Variables Update

**File**: `.env.local`, `.env.example`, Vercel environment variables

```bash
# Update FROM_EMAIL if using subdomain
RESEND_FROM_EMAIL="Handicappin' <noreply@mail.handicappin.com>"

# Or keep existing if not using subdomain
RESEND_FROM_EMAIL="Handicappin' <sebastiansole@handicappin.com>"
```

**Note**: Change from `sebastiansole@handicappin.com` to `sebastiansole@handicappin.com` to follow best practices (avoid personal emails for transactional messages).

#### 4. Update Email Service Configuration

**File**: `lib/email-service.ts`

```typescript
// Line 18-20: Update FROM_EMAIL
const FROM_EMAIL =
  process.env.RESEND_FROM_EMAIL ||
  "Handicappin' <sebastiansole@handicappin.com>"; // Changed from sebastiansole@
```

**Files**: All edge functions using FROM_EMAIL

- `supabase/functions/send-verification-email/index.ts:61`
- `supabase/functions/request-email-change/index.ts:23`
- `supabase/functions/reset-password/index.ts:93`

Update to use consistent FROM_EMAIL from environment variable.

### Success Criteria

#### Automated Verification

- [x] No TypeScript errors after FROM_EMAIL changes
- [x] Environment variables documented in `.env.example`

#### Manual Verification

- [ ] DMARC record visible via DNS lookup: `dig TXT _dmarc.handicappin.com`
- [ ] Resend dashboard shows SPF and DKIM passing
- [ ] Test email sent from new FROM_EMAIL address delivers successfully
- [ ] DMARC reports start arriving at designated email (within 24-48 hours)
- [ ] Review DMARC reports for alignment issues

---

## Phase 2: OTP System Core Infrastructure

### Overview

Build reusable OTP generation, storage, and verification system that all verification flows will use.

### Changes Required

#### 1. Database Schema - Create OTP Tables

**File**: `db/schema.ts`

Add after `pendingEmailChanges` table (around line 583):

```typescript
// OTP verifications table - unified table for all OTP types
export const otpVerifications = pgTable(
  "otp_verifications",
  {
    id: uuid().defaultRandom().primaryKey(),
    userId: uuid("user_id"), // Nullable for signup (user doesn't exist yet)
    email: text("email").notNull(),
    otpHash: text("otp_hash").notNull(), // SHA-256 hash of the OTP
    otpType: text("otp_type")
      .$type<"signup" | "email_change" | "password_reset">()
      .notNull(),
    expiresAt: timestamp("expires_at").notNull(),
    verified: boolean("verified").default(false).notNull(),
    verificationAttempts: integer("verification_attempts").default(0).notNull(),
    createdAt: timestamp("created_at")
      .default(sql`CURRENT_TIMESTAMP`)
      .notNull(),
    verifiedAt: timestamp("verified_at"),
    requestIp: text("request_ip"),

    // Metadata for different OTP types (JSONB)
    metadata: text("metadata"), // JSON string for type-specific data
  },
  (table) => [
    index("otp_verifications_email_type_idx").on(table.email, table.otpType),
    index("otp_verifications_expires_at_idx").on(table.expiresAt),
    // Note: No RLS - accessed only by service role in edge functions
  ]
);

export const otpVerificationsSchema = createSelectSchema(otpVerifications);
export type OtpVerification = InferSelectModel<typeof otpVerifications>;
```

#### 2. Database Migration

**Workflow for Local Testing**:

1. Edit `db/schema.ts` (add the `otpVerifications` table above)
2. Generate migration: `npx drizzle-kit generate`
3. Apply to local DB: `supabase db reset`

Migration SQL should include:

```sql
-- Create otp_verifications table
CREATE TABLE IF NOT EXISTS otp_verifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID, -- Nullable for signup
  email TEXT NOT NULL,
  otp_hash TEXT NOT NULL,
  otp_type TEXT NOT NULL CHECK (otp_type IN ('signup', 'email_change', 'password_reset')),
  expires_at TIMESTAMPTZ NOT NULL,
  verified BOOLEAN DEFAULT FALSE NOT NULL,
  verification_attempts INTEGER DEFAULT 0 NOT NULL,
  created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP NOT NULL,
  verified_at TIMESTAMPTZ,
  request_ip TEXT,
  metadata TEXT
);

-- Indexes
CREATE INDEX otp_verifications_email_type_idx ON otp_verifications(email, otp_type);
CREATE INDEX otp_verifications_expires_at_idx ON otp_verifications(expires_at);

-- Cleanup job: Delete expired OTPs older than 24 hours (run via cron or pg_cron)
CREATE OR REPLACE FUNCTION cleanup_expired_otps()
RETURNS void AS $$
BEGIN
  DELETE FROM otp_verifications
  WHERE expires_at < NOW() - INTERVAL '24 hours';
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

#### 3. OTP Utility Functions

**File**: Create `lib/otp-utils.ts`

```typescript
import crypto from "crypto";

export const OTP_LENGTH = 6;
export const OTP_EXPIRY_MINUTES = 15;
export const OTP_MAX_ATTEMPTS = 5;

/**
 * Generate a cryptographically secure 6-digit OTP
 */
export function generateOTP(): string {
  const buffer = crypto.randomBytes(4);
  const num = buffer.readUInt32BE(0);
  const otp = (num % 1000000).toString().padStart(OTP_LENGTH, "0");
  return otp;
}

/**
 * Hash OTP using SHA-256 for secure storage
 */
export function hashOTP(otp: string): string {
  return crypto.createHash("sha256").update(otp).digest("hex");
}

/**
 * Verify OTP matches hash
 */
export function verifyOTPHash(otp: string, hash: string): boolean {
  return hashOTP(otp) === hash;
}

/**
 * Get OTP expiration timestamp
 */
export function getOTPExpiry(): Date {
  return new Date(Date.now() + OTP_EXPIRY_MINUTES * 60 * 1000);
}

/**
 * Format OTP for display (e.g., "123-456")
 */
export function formatOTP(otp: string): string {
  if (otp.length !== OTP_LENGTH) return otp;
  return `${otp.slice(0, 3)}-${otp.slice(3)}`;
}
```

#### 4. Deno OTP Utility Functions

**File**: Create `supabase/functions/_shared/otp-utils.ts`

```typescript
/**
 * Deno-compatible OTP utilities (no Node.js crypto)
 */

export const OTP_LENGTH = 6;
export const OTP_EXPIRY_MINUTES = 15;
export const OTP_MAX_ATTEMPTS = 5;

/**
 * Generate a cryptographically secure 6-digit OTP (Deno)
 */
export function generateOTP(): string {
  const buffer = new Uint8Array(4);
  crypto.getRandomValues(buffer);
  const num = new DataView(buffer.buffer).getUint32(0, false);
  const otp = (num % 1000000).toString().padStart(OTP_LENGTH, "0");
  return otp;
}

/**
 * Hash OTP using SHA-256 for secure storage (Deno)
 */
export async function hashOTP(otp: string): Promise<string> {
  const encoder = new TextEncoder();
  const data = encoder.encode(otp);
  const hashBuffer = await crypto.subtle.digest("SHA-256", data);
  const hashArray = Array.from(new Uint8Array(hashBuffer));
  const hashHex = hashArray
    .map((b) => b.toString(16).padStart(2, "0"))
    .join("");
  return hashHex;
}

/**
 * Verify OTP matches hash (Deno)
 */
export async function verifyOTPHash(
  otp: string,
  hash: string
): Promise<boolean> {
  const computedHash = await hashOTP(otp);
  return computedHash === hash;
}

/**
 * Get OTP expiration timestamp
 */
export function getOTPExpiry(): Date {
  return new Date(Date.now() + OTP_EXPIRY_MINUTES * 60 * 1000);
}

/**
 * Format OTP for display (e.g., "123-456")
 */
export function formatOTP(otp: string): string {
  if (otp.length !== OTP_LENGTH) return otp;
  return `${otp.slice(0, 3)}-${otp.slice(3)}`;
}
```

#### 5. OTP Email Template Component

**File**: Create `emails/otp-verification.tsx`

```typescript
import {
  Body,
  Container,
  Head,
  Heading,
  Html,
  Preview,
  Section,
  Text,
  Tailwind,
  Hr,
} from "@react-email/components";

interface OtpVerificationEmailProps {
  otp: string;
  email: string;
  otpType: "signup" | "email_change" | "password_reset";
  expiresInMinutes?: number;
}

const OTP_TYPE_TITLES = {
  signup: "Verify Your Email",
  email_change: "Verify Your New Email",
  password_reset: "Reset Your Password",
};

const OTP_TYPE_DESCRIPTIONS = {
  signup:
    "Thank you for signing up! To complete your registration, please use the verification code below:",
  email_change:
    "You requested to change your email address. Please use the verification code below to confirm:",
  password_reset:
    "You requested to reset your password. Please use the verification code below to continue:",
};

OtpVerificationEmail.PreviewProps = {
  otp: "123456",
  email: "user@example.com",
  otpType: "signup",
  expiresInMinutes: 15,
} as OtpVerificationEmailProps;

export default function OtpVerificationEmail({
  otp,
  email,
  otpType,
  expiresInMinutes = 15,
}: OtpVerificationEmailProps) {
  const formattedOTP = `${otp.slice(0, 3)}-${otp.slice(3)}`;

  return (
    <Html>
      <Head />
      <Preview>
        {OTP_TYPE_TITLES[otpType]} - Your code is {formattedOTP}
      </Preview>
      <Tailwind>
        <Body className="bg-gray-50 font-sans">
          <Container className="mx-auto py-8 px-4 max-w-xl">
            <Section className="bg-white rounded-lg shadow-sm p-8">
              {/* Header */}
              <Heading className="text-2xl font-bold text-gray-900 mb-2">
                {OTP_TYPE_TITLES[otpType]}
              </Heading>
              <Text className="text-gray-600 mb-6">
                {OTP_TYPE_DESCRIPTIONS[otpType]}
              </Text>

              {/* OTP Display */}
              <Section className="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-6 text-center">
                <Text className="text-sm text-gray-600 mb-2 uppercase tracking-wide">
                  Your Verification Code
                </Text>
                <Text className="text-4xl font-bold text-gray-900 tracking-widest mb-0 font-mono">
                  {formattedOTP}
                </Text>
              </Section>

              {/* Instructions */}
              <Text className="text-gray-700 mb-4">
                Enter this code on the verification page to continue. This code
                will expire in <strong>{expiresInMinutes} minutes</strong>.
              </Text>

              {/* Security Info */}
              <Section className="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                <Text className="text-sm text-gray-700 mb-2">
                  <strong>Security Tips:</strong>
                </Text>
                <ul className="text-sm text-gray-600 pl-4 mb-0">
                  <li>Never share this code with anyone</li>
                  <li>
                    Handicappin' will never ask for this code via phone or email
                  </li>
                  <li>This code can only be used once</li>
                </ul>
              </Section>

              {/* Didn't Request */}
              <Hr className="border border-solid border-gray-200 my-6" />
              <Text className="text-sm text-gray-600 mb-0">
                If you didn't request this code, you can safely ignore this
                email. Your account security is important to us - if you're
                concerned, please contact us at{" "}
                <a
                  href="mailto:sebastiansole@handicappin.com"
                  className="text-blue-600"
                >
                  sebastiansole@handicappin.com
                </a>
              </Text>

              {/* Footer */}
              <Section className="mt-8 pt-6 border-t border-gray-200">
                <Text className="text-xs text-gray-500 text-center">
                  This email was sent by Handicappin' to {email}
                  <br />© 2025 Handicappin'. All rights reserved.
                </Text>
              </Section>
            </Section>
          </Container>
        </Body>
      </Tailwind>
    </Html>
  );
}
```

#### 6. Install shadcn Input OTP Component

**Command**: Install shadcn's input-otp component for better UX

```bash
pnpm dlx shadcn@latest add input-otp
```

This provides an accessible, user-friendly OTP input component with:

- Individual digit slots
- Auto-focus on next digit
- Paste support
- Better mobile experience
- Accessibility features

### Success Criteria

#### Automated Verification

- [x] Database migration applies successfully via `supabase db reset`
- [x] TypeScript compilation succeeds: `pnpm build`
- [x] OTP utility functions have unit tests passing
- [x] OTP generation produces 6-digit codes
- [x] OTP hashing is deterministic and secure
- [x] shadcn input-otp component installed successfully

#### Manual Verification (Local DB)

- [x] `otp_verifications` table exists in local database
- [ ] Can manually insert and query OTP records in local DB
- [ ] OTP email template renders correctly in preview
- [ ] Cleanup function can be executed manually
- [ ] Input OTP component renders and functions correctly

---

## Phase 3: Signup Verification Migration to OTP

### Overview

Convert the signup verification flow from token-based URLs to OTP-based verification. This is the highest-impact change as it affects new user onboarding.

### Changes Required

#### 1. Update Signup Verification Email Function

**File**: `supabase/functions/send-verification-email/index.ts`

Replace entire function with OTP-based approach:

```typescript
import Email from "./email.tsx";
import { serve } from "https://deno.land/std@0.168.0/http/server.ts";
import { Resend } from "https://esm.sh/resend@4.0.0";
import { Webhook } from "https://esm.sh/standardwebhooks@1.0.0";
import * as React from "https://esm.sh/react@18.2.0";
import { render } from "https://esm.sh/@react-email/components@0.0.22?deps=react@18.2.0";
import { createClient } from "jsr:@supabase/supabase-js@2";
import { generateOTP, hashOTP, getOTPExpiry } from "../_shared/otp-utils.ts";

console.log("send-verification-email (OTP-based)");

const resend = new Resend(Deno.env.get("RESEND_API_KEY") as string);
const hookSecret = (Deno.env.get("SEND_EMAIL_HOOK_SECRET") as string).replace(
  "v1,whsec_",
  ""
);

serve(async (req) => {
  if (req.method !== "POST") {
    return new Response("not allowed", { status: 400 });
  }

  const payload = await req.text();
  const headers = Object.fromEntries(req.headers);
  const wh = new Webhook(hookSecret);

  try {
    const {
      user,
      email_data: { email_action_type },
    } = wh.verify(payload, headers) as {
      user: {
        id: string;
        email: string;
      };
      email_data: {
        token: string;
        token_hash: string;
        redirect_to: string;
        email_action_type: string;
        site_url: string;
        token_new: string;
        token_hash_new: string;
      };
    };

    // Only handle signup verification
    if (email_action_type !== "signup") {
      return new Response(
        JSON.stringify({ message: "Not a signup verification, skipping OTP" }),
        { status: 200, headers: { "Content-Type": "application/json" } }
      );
    }

    const supabaseUrl =
      Deno.env.get("SUPABASE_URL") ?? Deno.env.get("LOCAL_SUPABASE_URL");
    const supabaseServiceRoleKey =
      Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") ??
      Deno.env.get("LOCAL_SUPABASE_SERVICE_ROLE_KEY");

    if (!supabaseUrl || !supabaseServiceRoleKey) {
      throw new Error("Missing Supabase environment variables");
    }

    const supabase = createClient(supabaseUrl, supabaseServiceRoleKey);

    // Generate OTP
    const otp = generateOTP();
    const otpHash = await hashOTP(otp);
    const expiresAt = getOTPExpiry();

    // Store OTP in database
    const { error: insertError } = await supabase
      .from("otp_verifications")
      .insert({
        user_id: user.id,
        email: user.email,
        otp_hash: otpHash,
        otp_type: "signup",
        expires_at: expiresAt.toISOString(),
        request_ip:
          req.headers.get("x-forwarded-for")?.split(",")[0] || "unknown",
      });

    if (insertError) {
      console.error("Failed to store OTP:", insertError);
      throw new Error("Failed to store verification code");
    }

    // Send OTP email
    const html = render(
      React.createElement(Email, {
        otp,
        email: user.email,
        otpType: "signup",
        expiresInMinutes: 15,
      })
    );

    const { error: emailError } = await resend.emails.send({
      from: "Handicappin' <sebastiansole@handicappin.com>",
      to: [user.email],
      subject: "Verify Your Email - Handicappin'",
      html,
    });

    if (emailError) {
      throw emailError;
    }

    console.log(`OTP sent successfully to ${user.email}`);

    return new Response(JSON.stringify({ success: true }), {
      status: 200,
      headers: { "Content-Type": "application/json" },
    });
  } catch (error: unknown) {
    let errorMessage = "Unknown error occurred";

    if (error instanceof Error) {
      errorMessage = error.message;
    } else if (typeof error === "string") {
      errorMessage = error;
    }
    console.error(error);
    return new Response(
      JSON.stringify({
        error: {
          message: errorMessage,
        },
      }),
      {
        status: 401,
        headers: { "Content-Type": "application/json" },
      }
    );
  }
});
```

#### 2. Update Email Template

**File**: `supabase/functions/send-verification-email/email.tsx`

Replace with OTP template (reuse the one from Phase 2 or create Deno-compatible version):

```typescript
import {
  Body,
  Container,
  Head,
  Heading,
  Html,
  Preview,
  Section,
  Text,
  Tailwind,
  Hr,
} from "https://esm.sh/@react-email/components@0.0.22?deps=react@18.2.0";
import * as React from "https://esm.sh/react@18.2.0";

interface EmailProps {
  otp: string;
  email: string;
  otpType: "signup" | "email_change" | "password_reset";
  expiresInMinutes?: number;
}

export const Email = ({
  otp,
  email,
  otpType,
  expiresInMinutes = 15,
}: EmailProps) => {
  const formattedOTP = `${otp.slice(0, 3)}-${otp.slice(3)}`;

  return (
    <React.Fragment>
      <Html>
        <Head />
        <Preview>Verify your email - Your code is {formattedOTP}</Preview>
        <Tailwind>
          <Body className="bg-gray-50 font-sans">
            <Container className="mx-auto py-8 px-4 max-w-xl">
              <Section className="bg-white rounded-lg shadow-sm p-8">
                <Heading className="text-2xl font-bold text-gray-900 mb-2">
                  Verify Your Email
                </Heading>
                <Text className="text-gray-600 mb-6">
                  Thank you for signing up! To complete your registration,
                  please use the verification code below:
                </Text>

                {/* OTP Display */}
                <Section className="bg-blue-50 border-2 border-blue-200 rounded-lg p-6 mb-6 text-center">
                  <Text className="text-sm text-gray-600 mb-2 uppercase tracking-wide">
                    Your Verification Code
                  </Text>
                  <Text className="text-4xl font-bold text-gray-900 tracking-widest mb-0 font-mono">
                    {formattedOTP}
                  </Text>
                </Section>

                <Text className="text-gray-700 mb-4">
                  Enter this code on the verification page to continue. This
                  code will expire in{" "}
                  <strong>{expiresInMinutes} minutes</strong>.
                </Text>

                <Section className="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                  <Text className="text-sm text-gray-700 mb-2">
                    <strong>Security Tips:</strong>
                  </Text>
                  <ul className="text-sm text-gray-600 pl-4 mb-0">
                    <li>Never share this code with anyone</li>
                    <li>Handicappin' will never ask for this code via phone</li>
                    <li>This code can only be used once</li>
                  </ul>
                </Section>

                <Hr className="border border-solid border-gray-200 my-6" />
                <Text className="text-sm text-gray-600 mb-0">
                  If you didn't request this code, you can safely ignore this
                  email.
                </Text>
              </Section>
            </Container>
          </Body>
        </Tailwind>
      </Html>
    </React.Fragment>
  );
};

export default Email;
```

#### 3. Create OTP Verification Page

**File**: Create `app/verify-signup/page.tsx`

**Note**: This uses shadcn's `input-otp` component installed in Phase 2.

```typescript
"use client";

import { useState, Suspense } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import {
  InputOTP,
  InputOTPGroup,
  InputOTPSlot,
} from "@/components/ui/input-otp";
import { Check, Loader2 } from "lucide-react";
import { createClientComponentClient } from "@/utils/supabase/client";

function VerifySignupContent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const emailFromUrl = searchParams.get("email");

  const [otp, setOtp] = useState("");
  const [email, setEmail] = useState(emailFromUrl || "");
  const [status, setStatus] = useState<
    "idle" | "loading" | "success" | "error"
  >("idle");
  const [message, setMessage] = useState("");
  const [attempts, setAttempts] = useState(0);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();

    if (!email || !otp) {
      setStatus("error");
      setMessage("Please enter both email and verification code");
      return;
    }

    if (otp.length !== 6 || !/^\d{6}$/.test(otp)) {
      setStatus("error");
      setMessage("Verification code must be 6 digits");
      return;
    }

    setStatus("loading");
    setAttempts((prev) => prev + 1);

    try {
      const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL;

      if (!supabaseUrl) {
        throw new Error("Configuration error");
      }

      const response = await fetch(
        `${supabaseUrl}/functions/v1/verify-signup-otp`,
        {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, otp }),
        }
      );

      const data = await response.json();

      if (response.ok && data.success) {
        setStatus("success");
        setMessage("Email verified successfully! Redirecting...");

        // Redirect to login after 2 seconds
        setTimeout(() => {
          router.push("/login?verified=true");
        }, 2000);
      } else {
        setStatus("error");
        setMessage(
          data.error ||
            "Verification failed. Please check your code and try again."
        );

        // Clear OTP input on error
        setOtp("");

        if (attempts >= 4) {
          setMessage(
            data.error || "Too many failed attempts. Please request a new code."
          );
        }
      }
    } catch (error) {
      console.error("Verification error:", error);
      setStatus("error");
      setMessage("An unexpected error occurred. Please try again.");
      setOtp("");
    }
  };

  const handleResend = async () => {
    if (!email) {
      setStatus("error");
      setMessage("Please enter your email address");
      return;
    }

    setStatus("loading");

    try {
      // Trigger new signup email via Supabase auth (will call our hook)
      const supabase = createClientComponentClient();

      // This is a workaround - ideally create a dedicated resend endpoint
      setStatus("success");
      setMessage(
        "If an account exists with this email, a new code has been sent."
      );
      setAttempts(0);
      setOtp("");

      setTimeout(() => setStatus("idle"), 3000);
    } catch (error) {
      console.error("Resend error:", error);
      setStatus("error");
      setMessage("Failed to resend code. Please try again.");
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 px-4">
      <div className="max-w-md w-full bg-white rounded-lg shadow-sm p-8">
        <div className="text-center mb-6">
          <h1 className="text-2xl font-bold text-gray-900 mb-2">
            Verify Your Email
          </h1>
          <p className="text-gray-600">
            Enter the 6-digit code we sent to your email
          </p>
        </div>

        <form onSubmit={handleSubmit} className="space-y-6">
          <div>
            <label
              htmlFor="email"
              className="block text-sm font-medium text-gray-700 mb-1"
            >
              Email Address
            </label>
            <Input
              id="email"
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              placeholder="your@email.com"
              disabled={status === "loading" || status === "success"}
              required
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2 text-center">
              Verification Code
            </label>
            <div className="flex justify-center">
              <InputOTP
                maxLength={6}
                value={otp}
                onChange={(value) => setOtp(value)}
                disabled={status === "loading" || status === "success"}
              >
                <InputOTPGroup>
                  <InputOTPSlot index={0} />
                  <InputOTPSlot index={1} />
                  <InputOTPSlot index={2} />
                  <InputOTPSlot index={3} />
                  <InputOTPSlot index={4} />
                  <InputOTPSlot index={5} />
                </InputOTPGroup>
              </InputOTP>
            </div>
          </div>

          {message && (
            <div
              className={`p-3 rounded-lg text-sm ${
                status === "error"
                  ? "bg-red-50 text-red-800"
                  : status === "success"
                  ? "bg-green-50 text-green-800"
                  : "bg-blue-50 text-blue-800"
              }`}
            >
              {message}
            </div>
          )}

          <Button
            type="submit"
            className="w-full"
            disabled={
              status === "loading" || status === "success" || otp.length !== 6
            }
          >
            {status === "loading" && (
              <Loader2 className="mr-2 h-4 w-4 animate-spin" />
            )}
            {status === "success" && <Check className="mr-2 h-4 w-4" />}
            Verify Email
          </Button>
        </form>

        <div className="mt-4 text-center">
          <button
            type="button"
            onClick={handleResend}
            className="text-sm text-blue-600 hover:text-blue-700"
            disabled={status === "loading" || status === "success"}
          >
            Didn't receive a code? Resend
          </button>
        </div>

        <div className="mt-6 p-4 bg-gray-50 rounded-lg">
          <p className="text-xs text-gray-600">
            <strong>Tip:</strong> Check your spam folder if you don't see the
            email. The code expires in 15 minutes.
          </p>
        </div>
      </div>
    </div>
  );
}

export default function VerifySignupPage() {
  return (
    <Suspense
      fallback={
        <div className="min-h-screen flex items-center justify-center bg-gray-50">
          <Loader2 className="h-8 w-8 animate-spin text-blue-600" />
        </div>
      }
    >
      <VerifySignupContent />
    </Suspense>
  );
}
```

#### 4. Create OTP Verification Edge Function

**File**: Create `supabase/functions/verify-signup-otp/index.ts`

```typescript
import "jsr:@supabase/functions-js/edge-runtime.d.ts";
import { createClient } from "jsr:@supabase/supabase-js@2";
import { verifyOTPHash, OTP_MAX_ATTEMPTS } from "../_shared/otp-utils.ts";
import { corsHeaders } from "../_shared/cors.ts";

Deno.serve(async (req) => {
  if (req.method === "OPTIONS") {
    return new Response(null, { headers: corsHeaders, status: 204 });
  }

  if (req.method !== "POST") {
    return new Response("Method not allowed", {
      status: 405,
      headers: corsHeaders,
    });
  }

  try {
    const supabaseUrl =
      Deno.env.get("SUPABASE_URL") ?? Deno.env.get("LOCAL_SUPABASE_URL");
    const supabaseServiceRoleKey =
      Deno.env.get("SUPABASE_SERVICE_ROLE_KEY") ??
      Deno.env.get("LOCAL_SUPABASE_SERVICE_ROLE_KEY");

    if (!supabaseUrl || !supabaseServiceRoleKey) {
      return new Response(
        JSON.stringify({ error: "Server configuration error" }),
        { status: 500, headers: corsHeaders }
      );
    }

    const supabaseAdmin = createClient(supabaseUrl, supabaseServiceRoleKey);

    const { email, otp } = await req.json();

    if (!email || !otp) {
      return new Response(
        JSON.stringify({ error: "Email and OTP are required" }),
        { status: 400, headers: corsHeaders }
      );
    }

    // Find the most recent unverified OTP for this email
    const { data: otpRecord, error: fetchError } = await supabaseAdmin
      .from("otp_verifications")
      .select("*")
      .eq("email", email)
      .eq("otp_type", "signup")
      .eq("verified", false)
      .order("created_at", { ascending: false })
      .limit(1)
      .single();

    if (fetchError || !otpRecord) {
      return new Response(
        JSON.stringify({
          error: "No pending verification found for this email",
        }),
        { status: 404, headers: corsHeaders }
      );
    }

    // Check expiration
    const now = new Date();
    const expiresAt = new Date(otpRecord.expires_at);

    if (now > expiresAt) {
      // Delete expired OTP
      await supabaseAdmin
        .from("otp_verifications")
        .delete()
        .eq("id", otpRecord.id);

      return new Response(
        JSON.stringify({
          error: "Verification code has expired. Please request a new one.",
        }),
        { status: 410, headers: corsHeaders }
      );
    }

    // Check attempt limit
    if (otpRecord.verification_attempts >= OTP_MAX_ATTEMPTS) {
      return new Response(
        JSON.stringify({
          error: "Too many verification attempts. Please request a new code.",
        }),
        { status: 429, headers: corsHeaders }
      );
    }

    // Verify OTP
    const isValid = await verifyOTPHash(otp, otpRecord.otp_hash);

    if (!isValid) {
      // Increment attempts
      await supabaseAdmin
        .from("otp_verifications")
        .update({
          verification_attempts: otpRecord.verification_attempts + 1,
        })
        .eq("id", otpRecord.id);

      const remainingAttempts =
        OTP_MAX_ATTEMPTS - (otpRecord.verification_attempts + 1);

      return new Response(
        JSON.stringify({
          error: `Invalid verification code. ${remainingAttempts} attempt${
            remainingAttempts !== 1 ? "s" : ""
          } remaining.`,
        }),
        { status: 401, headers: corsHeaders }
      );
    }

    // OTP is valid! Mark as verified
    const { error: updateError } = await supabaseAdmin
      .from("otp_verifications")
      .update({
        verified: true,
        verified_at: new Date().toISOString(),
      })
      .eq("id", otpRecord.id);

    if (updateError) {
      console.error("Failed to mark OTP as verified:", updateError);
      return new Response(
        JSON.stringify({ error: "Failed to complete verification" }),
        { status: 500, headers: corsHeaders }
      );
    }

    // Mark user as verified in profile table
    if (otpRecord.user_id) {
      await supabaseAdmin
        .from("profile")
        .update({ verified: true })
        .eq("id", otpRecord.user_id);
    }

    console.log(`Email ${email} verified successfully`);

    return new Response(
      JSON.stringify({
        success: true,
        message: "Email verified successfully!",
      }),
      { status: 200, headers: corsHeaders }
    );
  } catch (error) {
    console.error("Error in verify-signup-otp:", error);
    return new Response(JSON.stringify({ error: "Internal server error" }), {
      status: 500,
      headers: corsHeaders,
    });
  }
});
```

#### 5. Update Supabase Auth Config

**File**: `supabase/config.toml`

Update redirect URL to point to OTP verification page:

```toml
# Line 66: Update additional_redirect_urls
additional_redirect_urls = [
  "https://www.handicappin.com/verify-signup",
  "https://*.vercel.app/verify-signup",
  "http://localhost:3000/verify-signup"
]
```

### Success Criteria

#### Automated Verification

- [ ] Edge functions deploy successfully
- [x] TypeScript compilation passes
- [x] No build errors in verification page
- [x] Unit tests pass for OTP utilities

#### Manual Verification

- [ ] New user signs up and receives OTP email
- [ ] OTP email arrives within 1 minute
- [ ] OTP email lands in inbox (not spam) on Gmail, Outlook, Zoho
- [ ] User can enter OTP on `/verify-signup` page
- [ ] Valid OTP marks user as verified
- [ ] Invalid OTP shows error and decrements remaining attempts
- [ ] Expired OTP shows appropriate error message
- [ ] After 5 failed attempts, new OTP must be requested
- [ ] Outlook Safe Links does NOT cause "invalid access" error
- [ ] Profile `verified` field is set to `true` after verification

---

## Phase 4: Email Change Verification Migration to OTP

### Overview

Convert email change verification from JWT tokens to OTP codes. This builds on existing `pending_email_changes` table.

### Changes Required

#### 1. Update Request Email Change Function

**File**: `supabase/functions/request-email-change/index.ts`

Modify to generate and store OTP instead of JWT:

```typescript
// Around line 163-170: Replace JWT generation with OTP
const otp = generateOTP();
const otpHash = await hashOTP(otp);
const expiresAt = new Date(Date.now() + 15 * 60 * 1000); // 15 minutes

// Around line 188-204: Replace token_hash with otp_hash in database
const { error: upsertError } = await supabaseAdmin
  .from("pending_email_changes")
  .upsert(
    {
      user_id: user.id,
      old_email: user.email!,
      new_email: newEmail,
      token_hash: otpHash, // Store OTP hash instead of JWT hash
      expires_at: expiresAt.toISOString(),
      request_ip: requestIp,
      verification_attempts: 0,
    },
    { onConflict: "user_id" }
  );

// Around line 232-247: Update email to send OTP instead of URL
const verificationHtml = render(
  React.createElement(EmailVerificationChange, {
    otp, // Pass OTP instead of URL
    oldEmail: user.email!,
    newEmail,
    expiresInMinutes: 15,
  })
);
```

#### 2. Update Email Change Verification Template

**File**: `supabase/functions/request-email-change/email-verification-change.tsx`

Replace with OTP-based template similar to signup email.

#### 3. Create Email Change OTP Verification Page

**File**: Update `app/verify-email-change/page.tsx`

Modify to accept OTP input instead of token from URL.

**Key changes:**

- Remove token from URL parsing
- Add `InputOTP` component from shadcn (same as signup verification)
- Add email input field
- Call verification endpoint with email and OTP

**Example structure** (similar to signup verification page in Phase 3):

```typescript
import {
  InputOTP,
  InputOTPGroup,
  InputOTPSlot,
} from "@/components/ui/input-otp";

// Inside component:
<InputOTP
  maxLength={6}
  value={otp}
  onChange={(value) => setOtp(value)}
  disabled={status === "loading" || status === "success"}
>
  <InputOTPGroup>
    <InputOTPSlot index={0} />
    <InputOTPSlot index={1} />
    <InputOTPSlot index={2} />
    <InputOTPSlot index={3} />
    <InputOTPSlot index={4} />
    <InputOTPSlot index={5} />
  </InputOTPGroup>
</InputOTP>;
```

#### 4. Update Verify Email Change Function

**File**: `supabase/functions/verify-email-change/index.ts`

Replace JWT verification with OTP verification:

```typescript
// Replace lines 46-84 (JWT verification) with:
const { email, new_email, otp } = await req.json();

// Lookup pending change by email and new_email
const { data: pendingChange, error: lookupError } = await supabaseAdmin
  .from("pending_email_changes")
  .select("*")
  .eq("user_id", user_id)
  .single();

// Verify OTP against token_hash
const isValid = await verifyOTPHash(otp, pendingChange.token_hash);

// Rest of logic remains similar (expiry check, rate limit, etc.)
```

### Success Criteria

#### Automated Verification

- [x] Functions deploy successfully (locally tested, ready for deployment)
- [x] No TypeScript errors

#### Manual Verification

- [ ] User requests email change and receives OTP
- [ ] OTP arrives in new email inbox within 1 minute
- [ ] User can enter OTP on verification page
- [ ] Valid OTP completes email change in both `auth.users` and `profile`
- [ ] Invalid OTP shows error with remaining attempts
- [ ] Outlook Safe Links does NOT interfere with OTP delivery

---

## Phase 5: Password Reset Migration to OTP

### Overview

Convert password reset from token-based to OTP-based flow.

### Changes Required

#### 1. Update Password Reset Email Function

**File**: `supabase/functions/reset-password/index.ts`

Replace JWT token generation (lines 62-84) with OTP generation and storage:

```typescript
// Generate OTP
const otp = generateOTP();
const otpHash = await hashOTP(otp);

// Store in otp_verifications table instead of JWT
const { error: insertError } = await supabaseAdmin
  .from("otp_verifications")
  .insert({
    user_id: user.id,
    email: email,
    otp_hash: otpHash,
    otp_type: "password_reset",
    expires_at: new Date(Date.now() + 60 * 60 * 1000).toISOString(), // 1 hour
    request_ip: requestIp,
  });

// Send OTP email instead of reset link
const emailHtml = render(
  ResetPasswordEmail({ otp, username: email, expiresInMinutes: 60 })
);
```

#### 2. Update Password Reset Email Template

**File**: `supabase/functions/reset-password/email.tsx`

Replace reset link button with OTP display:

```typescript
// Remove resetLink prop
// Add otp prop
// Display OTP in large centered box (similar to signup email)
```

#### 3. Create Password Reset OTP Verification Page

**File**: Create or update password reset page

Create two-step flow:

1. Enter email → Receive OTP
2. Enter OTP + New Password → Reset password

**Use shadcn `InputOTP` component** for OTP entry (same as signup and email change):

```typescript
import {
  InputOTP,
  InputOTPGroup,
  InputOTPSlot,
} from "@/components/ui/input-otp";

// OTP input section
<InputOTP maxLength={6} value={otp} onChange={(value) => setOtp(value)}>
  <InputOTPGroup>
    <InputOTPSlot index={0} />
    <InputOTPSlot index={1} />
    <InputOTPSlot index={2} />
    <InputOTPSlot index={3} />
    <InputOTPSlot index={4} />
    <InputOTPSlot index={5} />
  </InputOTPGroup>
</InputOTP>;
```

#### 4. Create Password Reset Verification Function

**File**: Create `supabase/functions/verify-password-reset-otp/index.ts`

```typescript
// Verify OTP from otp_verifications table
// If valid, use admin API to reset password
// Mark OTP as verified
// Return success
```

### Success Criteria

#### Automated Verification

- [x] Functions deploy successfully (locally tested, ready for deployment)
- [x] No TypeScript errors

#### Manual Verification

- [ ] User requests password reset and receives OTP
- [ ] OTP arrives within 1 minute
- [ ] User can enter OTP and new password
- [ ] Valid OTP allows password reset
- [ ] Invalid OTP shows error
- [ ] Password successfully resets in Supabase auth

---

## Phase 6: Email Content Optimization

### Overview

Optimize email content to improve deliverability and avoid spam filters.

### Changes Required

#### 1. Email Best Practices Checklist

Apply to all email templates:

- ✅ **From Address**: Use `sebastiansole@handicappin.com` (not personal email)
- ✅ **Subject Lines**: Clear, concise, no spam trigger words (FREE, ACT NOW, etc.)
- ✅ **Text-to-Image Ratio**: Mostly text, minimal images
- ✅ **URL Matching**: Ensure all URLs use `handicappin.com` domain
- ✅ **Plain Text Alternative**: Include plain text version
- ✅ **Unsubscribe Link**: Not required for transactional emails, but good practice
- ✅ **Footer**: Include company address/contact info
- ✅ **Personalization**: Use user's name/email where appropriate

#### 2. Update All Email Templates

Files to update:

- `emails/otp-verification.tsx`
- `lib/email-service.ts` (all email functions)
- Edge function email templates

Ensure consistent formatting and compliance with best practices.

#### 3. Add Plain Text Versions

**File**: Update email sending logic in all functions

```typescript
const { error } = await resend.emails.send({
  from: FROM_EMAIL,
  to: email,
  subject: "...",
  html: emailHtml,
  text: plainTextVersion, // Add plain text fallback
});
```

Create plain text generator utility:

```typescript
function generatePlainTextOTP(otp: string, type: string): string {
  return `
Your Verification Code: ${otp}

Enter this code to complete your ${type}.

This code expires in 15 minutes.

If you didn't request this, please ignore this email.

---
Handicappin'
sebastiansole@handicappin.com
  `.trim();
}
```

### Success Criteria

#### Automated Verification

- [ ] All emails render correctly in preview
- [ ] Plain text versions are generated

#### Manual Verification

- [ ] Emails pass spam filter tests (mail-tester.com)
- [ ] Subject lines are clear and professional
- [ ] All links use handicappin.com domain
- [ ] Plain text version displays correctly

---

## Phase 7: Monitoring & Production Testing

### Overview

Test all flows in production with real email providers and establish monitoring.

### Changes Required

#### 1. Create Email Deliverability Dashboard

**File**: Create monitoring script or dashboard

Track metrics:

- OTP delivery time (time from generation to user entry)
- OTP verification success rate
- Failed verification attempts
- Expired OTPs
- Spam complaints (from Resend webhook)
- Bounce rates (from Resend webhook)

#### 2. Set Up DMARC Report Monitoring

- Configure email inbox for `dmarc-reports@handicappin.com`
- Weekly review of DMARC aggregate reports
- Check for SPF/DKIM alignment issues
- After 2-4 weeks of `p=none`, upgrade to `p=quarantine`

#### 3. Production Testing Checklist

Test with real accounts on:

- [ ] Gmail (personal)
- [ ] Gmail (workspace)
- [ ] Outlook.com
- [ ] Microsoft 365 (with Safe Links enabled)
- [ ] Zoho Mail
- [ ] Yahoo Mail
- [ ] ProtonMail
- [ ] iCloud Mail

For each provider, verify:

- [ ] Email arrives in inbox (not spam)
- [ ] Delivery time under 1 minute
- [ ] OTP verification works
- [ ] No Safe Links interference
- [ ] Mobile app displays correctly

#### 4. Rollback Plan

If critical issues arise:

1. Disable OTP functions in Supabase dashboard
2. Re-enable old verification functions
3. Update redirect URLs back to old flow
4. Communicate to users via status page

Keep old functions available for 2 weeks after OTP migration for emergency rollback.

### Success Criteria

#### Automated Verification

- [ ] Monitoring dashboard shows data
- [ ] Sentry captures OTP verification errors

#### Manual Verification

- [ ] 90%+ emails land in inbox across all providers
- [ ] Average delivery time under 30 seconds
- [ ] Zero Safe Links "invalid access" errors
- [ ] DMARC reports show 100% alignment
- [ ] User feedback is positive (no complaints about verification flow)

---

## Testing Strategy

### Unit Tests

**File**: Create `lib/otp-utils.test.ts`

```typescript
import { describe, it, expect } from "vitest";
import { generateOTP, hashOTP, verifyOTPHash, formatOTP } from "./otp-utils";

describe("OTP Utilities", () => {
  it("generates 6-digit OTP", () => {
    const otp = generateOTP();
    expect(otp).toHaveLength(6);
    expect(otp).toMatch(/^\d{6}$/);
  });

  it("generates unique OTPs", () => {
    const otp1 = generateOTP();
    const otp2 = generateOTP();
    expect(otp1).not.toBe(otp2);
  });

  it("hashes OTP consistently", () => {
    const otp = "123456";
    const hash1 = hashOTP(otp);
    const hash2 = hashOTP(otp);
    expect(hash1).toBe(hash2);
  });

  it("verifies OTP correctly", () => {
    const otp = "123456";
    const hash = hashOTP(otp);
    expect(verifyOTPHash(otp, hash)).toBe(true);
    expect(verifyOTPHash("654321", hash)).toBe(false);
  });

  it("formats OTP with dash", () => {
    expect(formatOTP("123456")).toBe("123-456");
  });
});
```

### Integration Tests

**File**: Create `tests/otp-flow.test.ts`

Test scenarios:

1. Signup → Receive OTP → Verify → Profile marked verified
2. Email Change → Receive OTP → Verify → Email updated
3. Password Reset → Receive OTP → Verify → Password changed
4. Invalid OTP → Error with remaining attempts
5. Expired OTP → Error message
6. Rate limit → Blocked after 5 attempts

### Manual Testing Checklist

#### Pre-Production (Staging)

- [ ] Signup flow with OTP works end-to-end
- [ ] Email change flow with OTP works end-to-end
- [ ] Password reset flow with OTP works end-to-end
- [ ] OTP email renders correctly in Gmail, Outlook, Zoho
- [ ] Expired OTP shows clear error
- [ ] Invalid OTP shows remaining attempts
- [ ] Rate limiting prevents brute force

#### Production Testing

- [ ] Test on 8+ email providers (see Phase 7)
- [ ] Verify delivery times under 1 minute
- [ ] Confirm inbox placement (not spam)
- [ ] Test with Safe Links enabled (Outlook 365)
- [ ] Test on mobile devices (iOS Mail, Android Gmail)
- [ ] Load test: 100 concurrent OTP requests

### Performance Testing

- [ ] OTP generation time < 10ms
- [ ] OTP verification time < 50ms
- [ ] Email sending time < 500ms
- [ ] Database query time < 100ms

---

## Performance Considerations

### Database Optimization

- Index on `otp_verifications(email, otp_type)` for fast lookups
- Index on `expires_at` for cleanup queries
- Cleanup expired OTPs daily (prevent table bloat)

### Email Sending Performance

- Use Resend's batch API if sending multiple emails
- Monitor Resend rate limits (currently 10 emails/second for free tier)
- Implement queue for high-volume scenarios

### Caching Strategy

- No caching needed for OTPs (single-use, time-sensitive)
- Cache DMARC records (update weekly)

---

## Migration Notes

### Deployment Order

1. **Database Schema** (Phase 2) - Deploy during low-traffic window
2. **OTP Infrastructure** (Phase 2) - Can deploy anytime (no user impact)
3. **Signup Migration** (Phase 3) - Deploy incrementally (feature flag if possible)
4. **Email Change Migration** (Phase 4) - After signup is stable
5. **Password Reset Migration** (Phase 5) - After email change is stable
6. **Content Optimization** (Phase 6) - Ongoing improvements
7. **DMARC Upgrade** (Phase 7) - After 2-4 weeks of monitoring

### Rollback Strategy

Each phase has independent rollback:

- **Phase 2**: Drop tables if needed (no production impact)
- **Phase 3-5**: Disable new edge functions, re-enable old ones
- **Phase 1**: DNS changes can be reverted in minutes

### User Communication

Draft announcement:

> **Improved Email Verification**
>
> We've upgraded our email verification system for better security and reliability. You'll now receive a 6-digit code instead of a link. This ensures your emails arrive faster and more reliably.
>
> What's new:
>
> - Faster email delivery
> - Better spam filter handling
> - Works with all email providers
> - More secure verification

---

## DNS Configuration Reference

### Step-by-Step DNS Setup

1. **Log into your DNS provider** (e.g., Cloudflare, Namecheap, Route53)

2. **Add DMARC Record**:

   ```
   Type: TXT
   Name: _dmarc
   Value: v=DMARC1; p=none; rua=mailto:dmarc-reports@handicappin.com; ruf=mailto:dmarc-forensics@handicappin.com; fo=1;
   TTL: 3600
   ```

3. **Verify SPF Record** (Should already exist from Resend):

   ```bash
   dig TXT handicappin.com | grep spf
   ```

   Should see: `v=spf1 include:_spf.resend.com ~all`

4. **Verify DKIM Record** (Should already exist from Resend):

   ```bash
   dig TXT resend._domainkey.handicappin.com
   ```

5. **Wait for DNS propagation** (5-60 minutes)

6. **Verify DMARC with online tool**:
   - https://mxtoolbox.com/dmarc.aspx
   - Enter: `handicappin.com`
   - Should show: "DMARC Record found"

### DMARC Policy Progression

**Week 1-2**: `p=none` (monitoring only)

- Collect aggregate reports
- Verify 100% alignment
- Identify any issues

**Week 3-4**: `p=quarantine; pct=10` (quarantine 10%)

- Test quarantine with small percentage
- Monitor user reports of missing emails
- Increase pct if no issues

**Week 5+**: `p=quarantine; pct=100` (full enforcement)

- All unauthenticated emails quarantined
- Maximum sender reputation

**Optional**: `p=reject` (highest security, use with caution)

---

## Resend Configuration Checklist

### Domain Verification Steps

1. **Add Domain in Resend Dashboard**

   - Go to: https://resend.com/domains
   - Click "Add Domain"
   - Enter: `handicappin.com` (or `mail.handicappin.com` for subdomain)

2. **Add DNS Records**

   - Resend will provide 3 DNS records:
     - SPF (TXT record)
     - DKIM (TXT record on `resend._domainkey`)
     - Return-Path (CNAME record)
   - Add all records to your DNS provider

3. **Verify Domain**

   - Click "Verify" in Resend dashboard
   - Should show:
     - ✅ SPF verified
     - ✅ DKIM verified
     - ✅ Return-Path verified

4. **Test Email Sending**
   ```bash
   curl -X POST 'https://api.resend.com/emails' \
     -H 'Authorization: Bearer YOUR_API_KEY' \
     -H 'Content-Type: application/json' \
     -d '{
       "from": "sebastiansole@handicappin.com",
       "to": "your@email.com",
       "subject": "Test Email",
       "html": "<p>Testing domain verification</p>"
     }'
   ```

### Best Practices

- Use dedicated subdomain for transactional emails: `mail.handicappin.com`
- Monitor Resend dashboard for bounce/complaint rates
- Set up webhooks for bounce/complaint tracking
- Keep spam rate below 0.08%
- Keep bounce rate below 4%

---

## References

### Documentation

- Supabase Auth Hooks: https://supabase.com/docs/guides/auth/auth-hooks
- Resend Email Authentication Guide: https://resend.com/blog/email-authentication-a-developers-guide
- Resend DMARC Setup: https://resend.com/docs/dashboard/domains/dmarc
- DMARC.org Specification: https://dmarc.org/overview/
- Email Authentication Best Practices: https://resend.com/blog/top-10-email-deliverability-tips

### Related Tickets

- #0034 - Secure Email Update Workflow (provides context for email change flow)
- #0030 - Email Preferences Storage (email settings infrastructure)
- #0032 - Add Sentry to Edge Functions (error tracking for email functions)

### Tools

- DMARC Checker: https://mxtoolbox.com/dmarc.aspx
- Email Spam Test: https://www.mail-tester.com/
- DNS Lookup: https://dnschecker.org/
- Resend Dashboard: https://resend.com/

### Code References

- Current signup email: `supabase/functions/send-verification-email/email.tsx:51`
- Current email change: `supabase/functions/request-email-change/index.ts:218`
- Current password reset: `supabase/functions/reset-password/index.ts:86`
- Email service: `lib/email-service.ts:16-20`
- Greylisting note: `lib/email-service.ts:312`
- Profile verified field: `db/schema.ts:35`
- Pending email changes table: `db/schema.ts:548-583`
