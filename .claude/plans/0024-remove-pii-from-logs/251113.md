# Pragmatic PII Removal Implementation Plan

## Overview

Remove Personally Identifiable Information (PII) from application logs in preparation for third-party log aggregation services (Sentry/PostHog). This plan takes a pragmatic approach: simple helpers + integration-level scrubbing, avoiding overengineering while providing production-ready protection.

**Time Estimate:** 1-2 hours
**Priority:** Medium (must complete before adding Sentry/PostHog)
**Scope:** 4 files, ~25 log statements

## Current State Analysis

### What We Found (Actual Investigation Results)

**Files with PII Logging:**
1. `app/api/stripe/checkout/route.ts` - Logs user ID (line 113) and email (line 114)
2. `app/api/stripe/webhook/route.ts` - Logs user IDs in ~15 webhook handlers
3. `utils/supabase/middleware.ts` - Logs user ID in error case (line 172)
4. `lib/reconciliation/stripe-reconciliation.ts` - Logs user IDs in drift detection (~4 places)

**Total Impact:** 4 files, approximately 25 log statements

**What's NOT a Problem:**
- Stripe customer IDs (external identifiers, not PII)
- Price IDs (business data, not PII)
- Session IDs (ephemeral, not PII)
- Request IDs (system data, not PII)

### Key Discoveries

1. **Email logging is minimal** - Only 1 place logs emails
2. **User UUID logging is widespread** - But UUIDs alone are pseudonymous under GDPR
3. **No existing logging library** - Just console.log/warn/error throughout
4. **No log aggregation yet** - Logs currently go to stdout (low risk)
5. **Webhook logging is centralized** - Uses `lib/webhook-logger.ts` utility

### Why This Matters NOW

The user plans to add **Sentry and PostHog**. These services:
- Capture all console.log/warn/error output
- Send logs to third-party servers
- Are subject to their own security policies
- Create GDPR compliance obligations if PII is transmitted

**Without PII removal:** User emails and IDs would be visible to Sentry/PostHog staff and stored on their servers.

## Desired End State

### Success Criteria

#### Automated Verification:
- [ ] `pnpm build` passes without TypeScript errors
- [ ] `pnpm lint` passes without new warnings
- [ ] All imports resolve correctly

#### Manual Verification:
- [ ] No plaintext emails in logs (search codebase: `grep -r "user\.email" app/`)
- [ ] User IDs are truncated/redacted in logs (test checkout flow, check logs)
- [ ] Logs remain useful for debugging (can still correlate issues with truncated IDs)
- [ ] Sentry configuration scrubs PII patterns (when implemented)
- [ ] PostHog configuration blacklists sensitive properties (when implemented)

### What We're NOT Doing

- âŒ SHA-256 hashing of user IDs (overkill, breaks debugging)
- âŒ Creating `safeLog` wrapper (unnecessary abstraction)
- âŒ Adding ESLint rules (premature optimization)
- âŒ Auditing all 92 files with console.log (only 4 have PII)
- âŒ Complex auto-sanitization logic (Sentry/PostHog handle this)
- âŒ Creating a full structured logging system (defer to later)

## Implementation Approach

**Philosophy:** Pragmatic protection without overengineering

**Strategy:**
1. Create simple helper functions for PII redaction
2. Update the 4 affected files to use helpers
3. Provide Sentry/PostHog configurations for when they're added
4. Keep logs useful for debugging (truncated IDs, not full hashes)

**Why This Works:**
- Simple functions are easy to understand and maintain
- Sentry/PostHog have mature PII scrubbing built-in
- Truncated UUIDs (first 8 chars) still allow issue correlation
- No performance overhead from complex sanitization
- Can implement in 1-2 hours

---

## Phase 1: Create Simple Logging Helper

### Overview

Create a lightweight utility with two simple functions: redact user IDs and emails.

### Changes Required

#### 1. Create `lib/logging.ts`

**File:** `lib/logging.ts` (new file)

```typescript
/**
 * Simple PII redaction utilities for logs
 *
 * Use these before logging user data to prevent PII from reaching
 * third-party log aggregation services (Sentry, PostHog, etc.)
 */

/**
 * Redact user ID by showing only first 8 characters
 *
 * Example: "550e8400-e29b-41d4-a716-446655440000" â†’ "user_550e8400"
 *
 * This maintains correlation (same user = same truncated ID) while
 * preventing full UUID exposure in external log services.
 */
export function redactUserId(userId: string): string {
  return `user_${userId.slice(0, 8)}`;
}

/**
 * Redact email by hiding local part, keeping domain
 *
 * Example: "john.doe@example.com" â†’ "***@example.com"
 *
 * This shows context (what domain) without exposing identity.
 */
export function redactEmail(email: string): string {
  const [_, domain] = email.split('@');
  return `***@${domain || 'unknown'}`;
}
```

**Rationale:**
- **Simple truncation** is better than hashing for debugging
- **First 8 chars of UUID** provides enough uniqueness for correlation
- **Keeps domain visible** in emails for troubleshooting (e.g., "is this a Gmail user?")
- **No external dependencies** (crypto, etc.)
- **Fast** - string slicing has zero overhead

### Success Criteria

#### Automated Verification:
- [ ] File created at `lib/logging.ts`
- [ ] TypeScript compilation passes: `pnpm build`

#### Manual Verification:
- [ ] Can import functions: `import { redactUserId, redactEmail } from '@/lib/logging'`
- [ ] `redactUserId("550e8400-e29b-41d4-a716-446655440000")` returns `"user_550e8400"`
- [ ] `redactEmail("john@example.com")` returns `"***@example.com"`

---

## Phase 2: Update Checkout Route

### Overview

Remove email logging and redact user ID in the checkout endpoint.

### Changes Required

#### 1. Update `app/api/stripe/checkout/route.ts`

**File:** `app/api/stripe/checkout/route.ts`

**Step 1: Add import**

```typescript
import { redactUserId } from '@/lib/logging';
```

**Step 2: Update lines 112-115**

**Before:**
```typescript
console.log("Price ID:", priceId);
console.log("User ID:", user.id);
console.log("User Email:", user.email);
console.log("Plan:", plan);
```

**After:**
```typescript
console.log("Price ID:", priceId);
console.log("User:", redactUserId(user.id));
// Email removed - not needed for debugging, sensitive PII
console.log("Plan:", plan);
```

**Rationale:**
- Email provides no debugging value here (we have user ID)
- Price ID is safe (external identifier)
- Plan name is safe (business data)
- Truncated user ID still allows issue correlation

### Success Criteria

#### Automated Verification:
- [ ] TypeScript compilation passes: `pnpm build`
- [ ] No linting errors: `pnpm lint`

#### Manual Verification:
- [ ] Start checkout flow
- [ ] Check logs - should see `"User: user_550e8400"` format
- [ ] Confirm no email logged
- [ ] Verify checkout still works end-to-end

---

## Phase 3: Update Webhook Handler

### Overview

Redact user IDs in all webhook log messages.

### Changes Required

#### 1. Update `app/api/stripe/webhook/route.ts`

**File:** `app/api/stripe/webhook/route.ts`

**Step 1: Add import at top (around line 7)**

```typescript
import { redactUserId } from '@/lib/logging';
```

**Step 2: Update specific log lines**

Replace user ID logging in these functions:

**Line 246 - `handleCustomerCreated`:**
```typescript
// Before:
logWebhookSuccess(`Stripe customer created for user: ${userId}`);

// After:
logWebhookSuccess(`Stripe customer created for user: ${redactUserId(userId)}`);
```

**Line 274 - `handleCheckoutCompleted`:**
```typescript
// Before:
logWebhookSuccess(`Checkout completed for user: ${userId}`);

// After:
logWebhookSuccess(`Checkout completed for user: ${redactUserId(userId)}`);
```

**Line 287 - `handleCheckoutCompleted`:**
```typescript
// Before:
logWebhookSuccess(`Stripe customer ID stored for user: ${userId}`);

// After:
logWebhookSuccess(`Stripe customer ID stored for user: ${redactUserId(userId)}`);
```

**Line 371 - `handleCheckoutCompleted`:**
```typescript
// Before:
logWebhookSuccess(`Updated plan_selected to '${plan}' for user: ${userId} at checkout`);

// After:
logWebhookSuccess(`Updated plan_selected to '${plan}' for user: ${redactUserId(userId)} at checkout`);
```

**Line 478 - `handleCheckoutCompleted`:**
```typescript
// Before:
logPaymentEvent(`Payment confirmed - granting ${plan} access to user ${userId}`);

// After:
logPaymentEvent(`Payment confirmed - granting ${plan} access to user ${redactUserId(userId)}`);
```

**Line 493 - `handleCheckoutCompleted`:**
```typescript
// Before:
logWebhookSuccess(`Granted ${plan} access to user ${userId}`);

// After:
logWebhookSuccess(`Granted ${plan} access to user ${redactUserId(userId)}`);
```

**Line 495 - `handleCheckoutCompleted`:**
```typescript
// Before:
logWebhookError(`Error updating plan for user ${userId}`, dbError);

// After:
logWebhookError(`Error updating plan for user ${redactUserId(userId)}`, dbError);
```

**Line 501 - `handleCheckoutCompleted`:**
```typescript
// Before:
logPaymentEvent(`Payment pending for user ${userId} - waiting for payment_intent.succeeded`);

// After:
logPaymentEvent(`Payment pending for user ${redactUserId(userId)} - waiting for payment_intent.succeeded`);
```

**Line 519 - `handleCheckoutCompleted`:**
```typescript
// Before:
logWebhookInfo(`Stored pending lifetime purchase for user ${userId}`);

// After:
logWebhookInfo(`Stored pending lifetime purchase for user ${redactUserId(userId)}`);
```

**Line 521 - `handleCheckoutCompleted`:**
```typescript
// Before:
logWebhookError(`Error storing pending purchase for user ${userId}`, dbError);

// After:
logWebhookError(`Error storing pending purchase for user ${redactUserId(userId)}`, dbError);
```

**Line 527 - `handleCheckoutCompleted`:**
```typescript
// Before:
logPaymentEvent(`No payment required - granting ${plan} access to user ${userId}`);

// After:
logPaymentEvent(`No payment required - granting ${plan} access to user ${redactUserId(userId)}`);
```

**Line 542 - `handleCheckoutCompleted`:**
```typescript
// Before:
logWebhookSuccess(`Granted ${plan} access to user ${userId} (no payment required)`);

// After:
logWebhookSuccess(`Granted ${plan} access to user ${redactUserId(userId)} (no payment required)`);
```

**Line 544 - `handleCheckoutCompleted`:**
```typescript
// Before:
logWebhookError(`Error updating plan for user ${userId}`, dbError);

// After:
logWebhookError(`Error updating plan for user ${redactUserId(userId)}`, dbError);
```

**Line 585 - `handlePaymentIntentSucceeded`:**
```typescript
// Before:
logPaymentEvent(`Granting ${purchase.plan} access to user ${purchase.userId} after payment confirmation`);

// After:
logPaymentEvent(`Granting ${purchase.plan} access to user ${redactUserId(purchase.userId)} after payment confirmation`);
```

**Line 597 - `handlePaymentIntentSucceeded`:**
```typescript
// Before:
logWebhookSuccess(`Granted ${purchase.plan} access to user ${purchase.userId}`);

// After:
logWebhookSuccess(`Granted ${purchase.plan} access to user ${redactUserId(purchase.userId)}`);
```

**Line 599 - `handlePaymentIntentSucceeded`:**
```typescript
// Before:
logWebhookError(`Error updating plan for user ${purchase.userId}`, dbError);

// After:
logWebhookError(`Error updating plan for user ${redactUserId(purchase.userId)}`, dbError);
```

**Line 653 - `handlePaymentIntentFailed`:**
```typescript
// Before:
logWebhookWarning(`Payment failed for user ${purchase.userId} - marked pending purchase ${purchase.id} as failed`);

// After:
logWebhookWarning(`Payment failed for user ${redactUserId(purchase.userId)} - marked pending purchase ${purchase.id} as failed`);
```

**Line 731 - `handleInvoicePaymentFailed`:**
```typescript
// Before:
logWebhookSuccess(`Updated subscription status to past_due for user ${userId}`);

// After:
logWebhookSuccess(`Updated subscription status to past_due for user ${redactUserId(userId)}`);
```

**Line 737 - `handleInvoicePaymentFailed`:**
```typescript
// Before:
logWebhookWarning(`Final payment attempt failed for user ${userId} - subscription will be canceled by Stripe`, { ... });

// After:
logWebhookWarning(`Final payment attempt failed for user ${redactUserId(userId)} - subscription will be canceled by Stripe`, { ... });
```

**Line 827 - `handleChargeRefunded`:**
```typescript
// Before:
logPaymentEvent(`Full refund detected - revoking lifetime access for user ${userId}`);

// After:
logPaymentEvent(`Full refund detected - revoking lifetime access for user ${redactUserId(userId)}`);
```

**Line 843 - `handleChargeRefunded`:**
```typescript
// Before:
logWebhookSuccess(`Revoked lifetime access for user ${userId} due to full refund`);

// After:
logWebhookSuccess(`Revoked lifetime access for user ${redactUserId(userId)} due to full refund`);
```

**Line 852 - `handleChargeRefunded`:**
```typescript
// Before:
logWebhookInfo(`Full refund for non-lifetime plan (user ${userId}, plan ${currentPlan}) - subscription cancellation will be handled by subscription.deleted event`);

// After:
logWebhookInfo(`Full refund for non-lifetime plan (user ${redactUserId(userId)}, plan ${currentPlan}) - subscription cancellation will be handled by subscription.deleted event`);
```

**Line 857 - `handleChargeRefunded`:**
```typescript
// Before:
logWebhookInfo(`Partial refund (${formatAmount(amountRefunded, currency)}) for user ${userId} - no access changes`);

// After:
logWebhookInfo(`Partial refund (${formatAmount(amountRefunded, currency)}) for user ${redactUserId(userId)} - no access changes`);
```

**Line 942 - `handleDisputeCreated`:**
```typescript
// Before:
logWebhookWarning(`Dispute filed for user ${userId} - requires manual review`, { ... });

// After:
logWebhookWarning(`Dispute filed for user ${redactUserId(userId)} - requires manual review`, { ... });
```

**Line 1077 - `handleSubscriptionChange`:**
```typescript
// Before:
logWebhookSuccess(`Updated plan_selected to '${plan}' for user: ${userId}`);

// After:
logWebhookSuccess(`Updated plan_selected to '${plan}' for user: ${redactUserId(userId)}`);
```

**Line 1080 - `handleSubscriptionChange`:**
```typescript
// Before:
logWebhookError(`Error updating plan for user ${userId}`, error);

// After:
logWebhookError(`Error updating plan for user ${redactUserId(userId)}`, error);
```

**Line 1128 - `handleSubscriptionDeleted`:**
```typescript
// Before:
logWebhookSuccess(`Reverted to free tier for user: ${userId}`);

// After:
logWebhookSuccess(`Reverted to free tier for user: ${redactUserId(userId)}`);
```

**Line 1130 - `handleSubscriptionDeleted`:**
```typescript
// Before:
logWebhookError(`Error reverting user ${userId} to free tier`, error);

// After:
logWebhookError(`Error reverting user ${redactUserId(userId)} to free tier`, error);
```

**Note:** Some log statements contain user IDs in context objects (like line 741, 928). These should be updated too:

**Line 741:**
```typescript
// Before:
{ attemptCount, subscriptionId, userId }

// After:
{ attemptCount, subscriptionId, userId: redactUserId(userId) }
```

### Success Criteria

#### Automated Verification:
- [ ] TypeScript compilation passes: `pnpm build`
- [ ] No linting errors: `pnpm lint`

#### Manual Verification:
- [ ] Trigger webhook events (create checkout, complete payment)
- [ ] Check logs - all user IDs should show `"user_550e8400"` format
- [ ] Verify webhooks still process correctly
- [ ] Verify no plaintext UUIDs in webhook logs

---

## Phase 4: Update Middleware

### Overview

Redact user ID in middleware error logging.

### Changes Required

#### 1. Update `utils/supabase/middleware.ts`

**File:** `utils/supabase/middleware.ts`

**Step 1: Add import at top (around line 7)**

```typescript
import { redactUserId } from '@/lib/logging';
```

**Step 2: Update line 172**

**Before:**
```typescript
console.error(`ðŸš¨ CRITICAL: Missing JWT billing claims for user ${enrichedUser.id}`, {
  pathname,
  timestamp: new Date().toISOString(),
  hasSession: !!session,
  hasAccessToken: !!session?.access_token,
});
```

**After:**
```typescript
console.error(`ðŸš¨ CRITICAL: Missing JWT billing claims for user ${redactUserId(enrichedUser.id)}`, {
  pathname,
  timestamp: new Date().toISOString(),
  hasSession: !!session,
  hasAccessToken: !!session?.access_token,
});
```

**Step 3: Update line 189**

**Before:**
```typescript
console.log(`âœ… JWT Auth: plan=${billing.plan}, status=${billing.status}, user=${enrichedUser.id}`);
```

**After:**
```typescript
console.log(`âœ… JWT Auth: plan=${billing.plan}, status=${billing.status}, user=${redactUserId(enrichedUser.id)}`);
```

**Step 4: Update line 201**

**Before:**
```typescript
console.warn(`âš ï¸ Subscription ${status} for user ${enrichedUser.id}`);
```

**After:**
```typescript
console.warn(`âš ï¸ Subscription ${status} for user ${redactUserId(enrichedUser.id)}`);
```

**Step 5: Update line 211**

**Before:**
```typescript
console.warn(`âš ï¸ Canceled subscription expired for user ${enrichedUser.id}`);
```

**After:**
```typescript
console.warn(`âš ï¸ Canceled subscription expired for user ${redactUserId(enrichedUser.id)}`);
```

**Step 6: Update line 220**

**Before:**
```typescript
console.warn(`âš ï¸ Subscription canceled (immediate) for user ${enrichedUser.id}`);
```

**After:**
```typescript
console.warn(`âš ï¸ Subscription canceled (immediate) for user ${redactUserId(enrichedUser.id)}`);
```

**Step 7: Update line 228**

**Before:**
```typescript
console.warn(`âš ï¸ Subscription expired for user ${enrichedUser.id}`);
```

**After:**
```typescript
console.warn(`âš ï¸ Subscription expired for user ${redactUserId(enrichedUser.id)}`);
```

**Step 8: Update line 247 (context object)**

**Before:**
```typescript
{
  userId: enrichedUser.id,
  pathname,
}
```

**After:**
```typescript
{
  userId: redactUserId(enrichedUser.id),
  pathname,
}
```

### Success Criteria

#### Automated Verification:
- [ ] TypeScript compilation passes: `pnpm build`
- [ ] No linting errors: `pnpm lint`

#### Manual Verification:
- [ ] Trigger middleware error case (remove billing claims from JWT temporarily)
- [ ] Check logs - user ID should be redacted: `"user_550e8400"`
- [ ] Verify middleware still works correctly

---

## Phase 5: Update Reconciliation Script

### Overview

Redact user IDs in the Stripe reconciliation cron job logs.

### Changes Required

#### 1. Update `lib/reconciliation/stripe-reconciliation.ts`

**File:** `lib/reconciliation/stripe-reconciliation.ts`

**Step 1: Add import at top (around line 3)**

```typescript
import { redactUserId } from '@/lib/logging';
```

**Step 2: Update line 76**

**Before:**
```typescript
console.error(`âŒ Error reconciling user ${user.id}:`, error);
```

**After:**
```typescript
console.error(`âŒ Error reconciling user ${redactUserId(user.id)}:`, error);
```

**Step 3: Update line 79 (context object)**

**Before:**
```typescript
{
  userId: user.id,
  field: "reconciliation",
  database_value: user.planSelected,
  stripe_value: "error",
  severity: "high",
  action: "error",
  error: error instanceof Error ? error.message : String(error),
}
```

**After:**
```typescript
{
  userId: redactUserId(user.id),
  field: "reconciliation",
  database_value: user.planSelected,
  stripe_value: "error",
  severity: "high",
  action: "error",
  error: error instanceof Error ? error.message : String(error),
}
```

**Step 4: Update line 140 (return object)**

**Before:**
```typescript
return {
  userId: user.id,
  field: "stripe_customer_id",
  database_value: null,
  stripe_value: "missing",
  severity: "high",
  action: "manual_review",
};
```

**After:**
```typescript
return {
  userId: redactUserId(user.id),
  field: "stripe_customer_id",
  database_value: null,
  stripe_value: "missing",
  severity: "high",
  action: "manual_review",
};
```

**Step 5: Update line 192**

**Before:**
```typescript
console.warn(`âš ï¸ Drift detected: User ${user.id} has active status but no Stripe subscription`);
```

**After:**
```typescript
console.warn(`âš ï¸ Drift detected: User ${redactUserId(user.id)} has active status but no Stripe subscription`);
```

**Step 6: Update line 209 (return object)**

**Before:**
```typescript
return {
  userId: user.id,
  field: "subscription_status",
  database_value: "active",
  stripe_value: "none",
  severity: "high",
  action: "auto_fixed",
};
```

**After:**
```typescript
return {
  userId: redactUserId(user.id),
  field: "subscription_status",
  database_value: "active",
  stripe_value: "none",
  severity: "high",
  action: "auto_fixed",
};
```

**Step 7: Update line 221**

**Before:**
```typescript
console.warn(`âš ï¸ Drift detected: User ${user.id} not active in DB but active in Stripe`);
```

**After:**
```typescript
console.warn(`âš ï¸ Drift detected: User ${redactUserId(user.id)} not active in DB but active in Stripe`);
```

**Step 8: Update line 242 (return object)**

**Before:**
```typescript
return {
  userId: user.id,
  field: "subscription_status",
  database_value: user.subscriptionStatus,
  stripe_value: "active",
  severity: "high",
  action: "auto_fixed",
};
```

**After:**
```typescript
return {
  userId: redactUserId(user.id),
  field: "subscription_status",
  database_value: user.subscriptionStatus,
  stripe_value: "active",
  severity: "high",
  action: "auto_fixed",
};
```

**Step 9: Update line 258**

**Before:**
```typescript
console.warn(`âš ï¸ Drift detected: Status mismatch for user ${user.id} (DB: ${user.subscriptionStatus}, Stripe: ${activeSubscription.status})`);
```

**After:**
```typescript
console.warn(`âš ï¸ Drift detected: Status mismatch for user ${redactUserId(user.id)} (DB: ${user.subscriptionStatus}, Stripe: ${activeSubscription.status})`);
```

**Step 10: Update line 271 (return object)**

**Before:**
```typescript
return {
  userId: user.id,
  field: "subscription_status",
  database_value: user.subscriptionStatus,
  stripe_value: activeSubscription.status,
  severity: "medium",
  action: "auto_fixed",
};
```

**After:**
```typescript
return {
  userId: redactUserId(user.id),
  field: "subscription_status",
  database_value: user.subscriptionStatus,
  stripe_value: activeSubscription.status,
  severity: "medium",
  action: "auto_fixed",
};
```

### Success Criteria

#### Automated Verification:
- [ ] TypeScript compilation passes: `pnpm build`
- [ ] No linting errors: `pnpm lint`

#### Manual Verification:
- [ ] Run reconciliation cron job: `curl http://localhost:3000/api/cron/reconcile-stripe`
- [ ] Check logs - user IDs should be redacted: `"user_550e8400"`
- [ ] Verify reconciliation still works correctly

---

## Phase 6: Configure Sentry (When Added)

### Overview

Configure Sentry's built-in PII scrubbing to catch any PII that slips through.

**IMPORTANT:** This phase should be completed BEFORE deploying Sentry to production.

### Changes Required

#### 1. Create/Update Sentry Configuration

**File:** `app/sentry.client.config.ts` (or wherever you initialize Sentry)

```typescript
import * as Sentry from "@sentry/nextjs";

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,

  // Set sample rate (optional)
  tracesSampleRate: 1.0,

  // Enable automatic session tracking
  autoSessionTracking: true,

  // PII Scrubbing Configuration
  beforeSend(event) {
    // Scrub PII from breadcrumbs
    if (event.breadcrumbs) {
      event.breadcrumbs = event.breadcrumbs.map(breadcrumb => {
        if (breadcrumb.message) {
          // Redact email addresses
          breadcrumb.message = breadcrumb.message.replace(
            /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g,
            '[EMAIL_REDACTED]'
          );

          // Redact full UUIDs (catch any that slipped through)
          breadcrumb.message = breadcrumb.message.replace(
            /[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/gi,
            '[UUID_REDACTED]'
          );
        }
        return breadcrumb;
      });
    }

    // Scrub PII from exception messages
    if (event.exception?.values) {
      event.exception.values = event.exception.values.map(exception => {
        if (exception.value) {
          exception.value = exception.value.replace(
            /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g,
            '[EMAIL_REDACTED]'
          );
          exception.value = exception.value.replace(
            /[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}/gi,
            '[UUID_REDACTED]'
          );
        }
        return exception;
      });
    }

    // Scrub PII from extra context
    if (event.extra) {
      Object.keys(event.extra).forEach(key => {
        if (key.toLowerCase().includes('email') || key.toLowerCase().includes('userid')) {
          event.extra![key] = '[REDACTED]';
        }
      });
    }

    return event;
  },

  // Don't send sensitive tags
  ignoreErrors: [
    // Add patterns for errors that might contain PII
    /user.*email/i,
  ],
});
```

**Also create server-side config:**

**File:** `app/sentry.server.config.ts`

```typescript
import * as Sentry from "@sentry/nextjs";

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,

  tracesSampleRate: 1.0,

  // Same beforeSend logic as client
  beforeSend(event) {
    // ... (same implementation as above)
    return event;
  },
});
```

### Success Criteria

#### Automated Verification:
- [ ] Sentry initializes without errors
- [ ] TypeScript compilation passes: `pnpm build`

#### Manual Verification:
- [ ] Trigger an error that would log a user ID
- [ ] Check Sentry dashboard - verify UUIDs are redacted
- [ ] Trigger an error with email - verify it's scrubbed
- [ ] Logs in local console still show truncated IDs (not affected by Sentry)

---

## Phase 7: Configure PostHog (When Added)

### Overview

Configure PostHog to blacklist sensitive properties and avoid capturing PII.

**IMPORTANT:** This phase should be completed BEFORE deploying PostHog to production.

### Changes Required

#### 1. Create PostHog Configuration

**File:** `lib/posthog.ts` (or wherever you initialize PostHog)

```typescript
import posthog from 'posthog-js';

// Initialize PostHog only on client-side
if (typeof window !== 'undefined') {
  posthog.init(process.env.NEXT_PUBLIC_POSTHOG_KEY!, {
    api_host: process.env.NEXT_PUBLIC_POSTHOG_HOST || 'https://app.posthog.com',

    // Disable automatic property capture that might include PII
    property_blacklist: [
      '$email',
      'email',
      'user_email',
      'userId',
      'user_id',
      '$current_url', // May contain sensitive query params
    ],

    // Don't capture text or elements that might contain PII
    mask_all_text: false, // Set to true if your app shows user emails in UI
    mask_all_element_attributes: false,

    // Sanitize properties before sending
    sanitize_properties: (properties, event) => {
      const sanitized = { ...properties };

      // Remove any property that looks like an email
      Object.keys(sanitized).forEach(key => {
        if (typeof sanitized[key] === 'string') {
          // Check if value looks like an email
          if (sanitized[key].includes('@') && sanitized[key].includes('.')) {
            delete sanitized[key];
          }

          // Check if value looks like a full UUID
          if (/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(sanitized[key])) {
            delete sanitized[key];
          }
        }
      });

      return sanitized;
    },

    // Disable session recording if you're capturing console logs
    // (console logs might contain PII even after redaction)
    disable_session_recording: false, // Set to true if concerned

    // If using session recording, mask sensitive elements
    session_recording: {
      maskAllInputs: true, // Mask form inputs
      maskTextSelector: '[data-private]', // Mask elements with this attribute
    },
  });
}

export default posthog;
```

**Also update your PostHog usage:**

**File:** `app/layout.tsx` (or wherever you use PostHog)

```typescript
'use client';

import posthog from '@/lib/posthog';
import { useEffect } from 'react';

export function PostHogProvider({ children }: { children: React.ReactNode }) {
  useEffect(() => {
    // Track page views
    posthog.capture('$pageview');

    // IMPORTANT: Never identify users with email or full UUID
    // Use truncated ID instead
    if (user) {
      posthog.identify(
        redactUserId(user.id), // Use truncated ID, not full UUID
        {
          plan: user.planSelected,
          // Don't include email or other PII
        }
      );
    }
  }, [user]);

  return <>{children}</>;
}
```

### Success Criteria

#### Automated Verification:
- [ ] PostHog initializes without errors
- [ ] TypeScript compilation passes: `pnpm build`

#### Manual Verification:
- [ ] Check PostHog dashboard - verify no email addresses appear
- [ ] Check PostHog dashboard - verify no full UUIDs appear
- [ ] Verify user events are still tracked correctly
- [ ] Verify identified users use truncated IDs

---

## Testing Strategy

### Unit Testing (Optional)

If you want to add tests for the logging utilities:

```typescript
// lib/__tests__/logging.test.ts
import { redactUserId, redactEmail } from '../logging';

describe('PII Redaction', () => {
  describe('redactUserId', () => {
    it('should truncate UUID to first 8 characters', () => {
      const uuid = '550e8400-e29b-41d4-a716-446655440000';
      expect(redactUserId(uuid)).toBe('user_550e8400');
    });

    it('should be consistent for same input', () => {
      const uuid = '550e8400-e29b-41d4-a716-446655440000';
      expect(redactUserId(uuid)).toBe(redactUserId(uuid));
    });
  });

  describe('redactEmail', () => {
    it('should hide local part, keep domain', () => {
      expect(redactEmail('john.doe@example.com')).toBe('***@example.com');
    });

    it('should handle emails without domain', () => {
      expect(redactEmail('invalid')).toBe('***@unknown');
    });
  });
});
```

### Manual Testing Checklist

**Before deploying to production:**

1. **Checkout Flow:**
   - [ ] Start checkout for premium plan
   - [ ] Check server logs - should see `"User: user_550e8400"` (not full UUID)
   - [ ] Verify NO email logged
   - [ ] Complete checkout successfully

2. **Webhook Processing:**
   - [ ] Trigger `checkout.session.completed` webhook
   - [ ] Check logs - all user IDs should be truncated
   - [ ] Trigger `customer.subscription.updated` webhook
   - [ ] Verify all webhook logs use redacted IDs

3. **Middleware:**
   - [ ] Access protected route as authenticated user
   - [ ] Check middleware logs - user ID should be truncated
   - [ ] Trigger middleware error (remove JWT claims)
   - [ ] Verify error logs use redacted IDs

4. **Reconciliation:**
   - [ ] Run reconciliation cron job
   - [ ] Check logs - all user IDs should be truncated
   - [ ] Verify reconciliation still detects drift correctly

5. **Sentry (when added):**
   - [ ] Trigger an error that includes user ID
   - [ ] Check Sentry dashboard - verify UUID is `[UUID_REDACTED]`
   - [ ] Trigger error with email - verify `[EMAIL_REDACTED]`

6. **PostHog (when added):**
   - [ ] Check PostHog events - verify no emails
   - [ ] Check PostHog user properties - verify truncated IDs
   - [ ] Verify session recordings don't show sensitive inputs

### Automated Testing Commands

```bash
# Type checking
pnpm build

# Linting
pnpm lint

# Unit tests (if you added them)
pnpm test

# Search for remaining PII in logs
grep -r "user\.email" app/
grep -r "user\.id" app/ | grep console
```

## Migration Notes

### Backward Compatibility

This change is **fully backward compatible**:
- No database changes
- No API changes
- Only affects log output
- Existing logs are unaffected

### Rollback Plan

If issues arise, rollback is simple:
1. Revert the 4 changed files
2. Delete `lib/logging.ts`
3. Redeploy

**Risk:** Very low - only changes log formatting

### Deployment Strategy

**Recommended:**
1. Deploy Stripe implementation first âœ…
2. Implement PII removal (this plan)
3. Test in staging/development
4. Deploy to production
5. THEN add Sentry/PostHog with PII scrubbing configured

**Order matters:** Configure Sentry/PostHog PII scrubbing BEFORE enabling them in production.

## Performance Considerations

**Impact:** Negligible (< 0.1ms per log statement)

- String slicing is O(1) operation
- No external API calls
- No complex regex (except in Sentry beforeSend)
- Sentry beforeSend adds ~1-2ms per error (acceptable)

## Documentation

### For Future Developers

Add this to your `README.md` or `CONTRIBUTING.md`:

```markdown
## Logging Guidelines

**NEVER log PII directly:**
- âŒ `console.log("User:", user.id)`
- âŒ `console.log("Email:", user.email)`

**ALWAYS use redaction helpers:**
- âœ… `import { redactUserId } from '@/lib/logging'`
- âœ… `console.log("User:", redactUserId(user.id))`

**What's safe to log:**
- Plan names (premium, unlimited, free)
- Stripe IDs (customer, subscription, price)
- System IDs (request ID, session ID)
- Business events (checkout completed, subscription updated)

**What's NOT safe:**
- User emails
- Full UUIDs (use truncated)
- Payment card details (obviously)
- API keys or secrets
```

### Comment in Code

Add a comment at the top of `lib/logging.ts`:

```typescript
/**
 * PII Redaction Utilities
 *
 * WHY: We use Sentry and PostHog for monitoring. These services capture
 * console.log output and send it to third-party servers. To comply with
 * GDPR and protect user privacy, we redact PII before logging.
 *
 * WHEN TO USE:
 * - Always use redactUserId() before logging user IDs
 * - Never log user emails (not needed for debugging)
 *
 * See: .claude/plans/0024-remove-pii-from-logs/251113.md
 */
```

## Definition of Done

### Automated Checks
- [ ] `pnpm build` passes without errors
- [ ] `pnpm lint` passes without new warnings
- [ ] All imports resolve correctly
- [ ] No TypeScript errors in changed files

### Manual Verification
- [ ] No plaintext emails in logs: `grep -r "user\.email" app/` returns 0 results
- [ ] User IDs are truncated in all logs (tested checkout, webhooks, middleware)
- [ ] Logs remain useful for debugging (can correlate issues with truncated IDs)
- [ ] Sentry configuration scrubs PII (when added)
- [ ] PostHog configuration blacklists PII (when added)

### Code Quality
- [ ] `lib/logging.ts` created with clear documentation
- [ ] All 4 files updated with `redactUserId()` import
- [ ] No hardcoded redaction (all use helper function)
- [ ] Comments added explaining PII protection

### Documentation
- [ ] Logging guidelines added to README or CONTRIBUTING.md
- [ ] Comment in `lib/logging.ts` explains why this exists
- [ ] This plan committed to `.claude/plans/` for future reference

## References

- Original ticket: `.claude/tickets/0024-remove-pii-from-logs.md`
- GDPR Article 32: [Pseudonymization requirement](https://gdpr-info.eu/art-32-gdpr/)
- Sentry PII Scrubbing: [Docs](https://docs.sentry.io/platforms/javascript/data-management/sensitive-data/)
- PostHog Privacy: [Docs](https://posthog.com/docs/privacy)

## Timeline

**Total Estimated Time:** 1-2 hours

- Phase 1 (Create helper): 10 minutes
- Phase 2 (Checkout route): 5 minutes
- Phase 3 (Webhook handler): 30 minutes (most changes)
- Phase 4 (Middleware): 10 minutes
- Phase 5 (Reconciliation): 10 minutes
- Phase 6 (Sentry config): 15 minutes (when adding Sentry)
- Phase 7 (PostHog config): 15 minutes (when adding PostHog)
- Testing: 15 minutes

## Notes

**Why this plan is better than the ticket:**
1. âœ… **No overengineering** - Simple helpers, not complex hashing
2. âœ… **Leverages existing tools** - Sentry/PostHog PII scrubbing
3. âœ… **Preserves debugging** - Truncated IDs still allow correlation
4. âœ… **Fast to implement** - 1-2 hours vs. full day
5. âœ… **Maintainable** - Simple code, easy for future developers

**What we skipped (and why):**
- SHA-256 hashing â†’ Overkill, breaks debugging
- `safeLog` wrapper â†’ Unnecessary abstraction
- ESLint rules â†’ Premature optimization
- Auditing 92 files â†’ Only 4 have PII

This plan provides production-ready PII protection without sacrificing developer productivity.
