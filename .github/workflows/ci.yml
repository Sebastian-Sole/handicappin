name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Environment variables for CI builds
# Stripe keys use real test-mode secrets for integration tests
# Other vars use dummy values (only needed for type checking)
env:
  DATABASE_URL: "postgresql://user:pass@localhost:5432/db"
  RESEND_API_KEY: "re_dummy_key"
  SEND_EMAIL_HOOK_SECRET: "dummy_hook_secret"
  STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
  STRIPE_WEBHOOK_SECRET: "whsec_dummy"
  STRIPE_PREMIUM_PRICE_ID: ${{ secrets.STRIPE_PREMIUM_PRICE_ID }}
  STRIPE_UNLIMITED_PRICE_ID: ${{ secrets.STRIPE_UNLIMITED_PRICE_ID }}
  STRIPE_UNLIMITED_LIFETIME_PRICE_ID: ${{ secrets.STRIPE_UNLIMITED_LIFETIME_PRICE_ID }}
  REDIS_URL: "redis://localhost:6379"
  KV_URL: "redis://localhost:6379"
  KV_REST_API_URL: "https://dummy-kv.upstash.io"
  KV_REST_API_TOKEN: "dummy_kv_token"
  KV_REST_API_READ_ONLY_TOKEN: "dummy_kv_readonly_token"
  ADMIN_ALERT_EMAILS: "admin@example.com"
  RESET_TOKEN_SECRET: "dummy_reset_secret_32chars_long!"
  SUPABASE_SERVICE_ROLE_KEY: "dummy_service_role_key"
  HANDICAP_CRON_SECRET: "dummy_handicap_cron_secret"
  STRIPE_CRON_SECRET: "dummy_stripe_cron_secret"
  NEXT_PUBLIC_SUPABASE_URL: "https://dummy.supabase.co"
  NEXT_PUBLIC_SUPABASE_ANON_KEY: "dummy_anon_key"
  NEXT_PUBLIC_APP_URL: "http://localhost:3000"

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install

      - name: Lint
        run: pnpm lint
        env:
          ESLINT_USE_FLAT_CONFIG: false

      - name: Type check
        run: pnpm build

      - name: Test
        run: pnpm test run

  schema-sync-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: 9

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Check schema sync
        run: node scripts/check-schema-sync.mjs
